<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MiniR√©seau ‚Äî Fil</title>
    <!-- Chargement de Tailwind CSS pour les utilitaires de base (hidden, flex, etc.) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Votre feuille de style personnalis√©e -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* Styles pour masquer/afficher les vues dans un contexte SPA */
        .tab-content { display: none; }
        .tab-content.active { display: flex; flex-direction: column; } /* Pour la timeline */
        #profile-view.active { display: block; } /* Pour le profil */
        .auth-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0, 0, 0, 0.8); z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    
    <!-- Zone pour afficher les messages (erreurs/succ√®s) - Absolue ou Fixe -->
    <div id="message-container" class="fixed top-4 right-4 z-[1001] w-full max-w-sm"></div>

    <!-- WRAPPER PRINCIPAL (Contenu de l'application) -->
    <div class="wrap" id="app-wrap">
        <!-- HEADER -->
        <header>
            <div class="logo">
                <div class="dot">MR</div>
                <div class="name">
                    <strong>MiniR√©seau</strong>
                    <div class="small">Un prototype social</div>
                </div>
            </div>
            <div class="search">
                <input id="searchInput" placeholder="Rechercher personnes ou posts..." />
            </div>
            <div class="nav-actions">
                <!-- Ces boutons sont masqu√©s si d√©connect√©, sinon on garde la nav -->
                <button class="btn" id="notifyBtn" onclick="toggleNotifications()">üîî <span id="notifCount" style="margin-left:6px">0</span></button>
                <button class="btn" id="newPostBtn">‚ûï Nouveau</button>
                <button class="btn" id="logoutBtn" onclick="logout()">üö™ D√©connexion</button>
            </div>
        </header>

        <!-- LEFT COLUMN -->
        <aside id="left-column">
            <div class="card">
                <div class="profile">
                    <div class="avatar" id="myAvatar">U?</div>
                    <div>
                        <div id="myName"><strong>Chargement...</strong></div>
                        <div class="muted" id="myHandle">@guest ¬∑ Statut</div>
                    </div>
                </div>
                <nav class="menu">
                  <!-- Navigation coh√©rente : onglets internes avec showTab() -->
                  <button id="feed-btn" onclick="showTab('feed')">üè† Fil d'actualit√©</button>
                  <button id="messages-btn" onclick="location.href='frontend/pages/message-v2.html'">üí¨ Messagerie</button>
                                    <button id="friends-btn" onclick="location.href='ami.html'">üë• Amis</button>
                                    <button id="profile-btn" onclick="goToProfile()">üë§ Profil</button>
                  <button id="constellation-btn" onclick="location.href='constellation.html'">üåå Constellation</button>
                  <button id="settings-btn" onclick="location.href='page_parametre.html'">‚öôÔ∏è Param√®tres</button>
                </nav>
            </div>

            <div style="height:12px"></div>

            <div class="card small">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div><strong>Statistiques</strong></div>
                    <div class="muted">en local</div>
                </div>
                <div style="display:flex;gap:8px;margin-top:10px">
					<div class="pill" style="cursor:pointer" onclick="showAllPosts()">Tous</div>
					<div class="pill" style="cursor:pointer" onclick="showMyPosts()">Posts <div id="statPosts" style="font-weight:700">0</div></div>
					<div class="pill">Amis <div id="statFriends" style="font-weight:700">0</div></div>
                </div>
            </div>
        </aside>

        <!-- MIDDLE: FEED -->
        <main id="feed-tab" class="tab-content active">
            <div class="card composer">
                <div class="composer-header">
                    <div class="composer-avatar" id="composer-avatar">U</div>
                    <div class="composer-meta">
                        <div class="composer-greeting" id="composer-greeting">Exprime-toi, √©tudiant ESME ‚ú®</div>
                        <div class="small muted composer-sub">Partage une pens√©e, une photo ou un moment de ta vie sur le campus.</div>
                    </div>
                </div>
                <textarea id="composer" placeholder="Quoi de neuf aujourd'hui ?"></textarea>
                <div class="composer-toolbar">
                    <div class="composer-actions-left">
                        <div class="small muted">Tu peux publier du texte, des liens et une photo depuis ton appareil.</div>
                        <label class="image-upload-pill">
                            <input type="file" id="imageFileInput" accept="image/*" />
                            üì∑ Ajouter une photo
                        </label>
                    </div>
                    <div class="composer-actions-right">
                        <button class="btn" id="clearBtn">Effacer</button>
                        <button class="btn" id="publishBtn">Publier</button>
                    </div>
                </div>
                <div id="imagePreviewContainer" class="image-preview" style="display:none">
                    <img id="imagePreview" alt="Pr√©visualisation de la photo" />
                    <button type="button" class="btn btn-small" id="removeImageBtn">Retirer la photo</button>
                </div>
            </div>

            <div class="feed" id="feed"></div>
            <div id="emptyFeed" class="center muted" style="padding:20px;display:none">
                Aucun post pour l'instant ‚Äî soyez le premier !
            </div>
        </main>
        
        <!-- MIDDLE: PROFIL UTILISATEUR (Nouvelle section) -->
        <main id="profile-tab" class="tab-content">
            <div id="profile-view" class="card">
                <h2>Mon Profil</h2>
                <div style="display:flex;align-items:center;gap:15px;margin-top:15px;padding-bottom:15px;border-bottom:1px solid var(--border)">
                    <div class="avatar" style="width:60px;height:60px;font-size:24px" id="profile-avatar"></div>
                    <div>
                        <h3 id="profile-full-name" style="font-weight:bold;font-size:1.5em"></h3>
                        <div class="muted">@<span id="profile-username"></span></div>
                    </div>
                </div>
                
                <div style="margin-top:20px">
                    <div class="row-info">
                        <strong>Email :</strong> <span id="profile-email"></span>
                    </div>
                    <div class="row-info">
                        <strong>Membre depuis :</strong> <span id="profile-created-at"></span>
                    </div>
                </div>
                
                <p style="margin-top:20px" class="muted">
                    Ici, vous pourrez bient√¥t modifier vos informations.
                </p>
            </div>
        </main>
        
        <!-- MIDDLE: OTHER TABS (Messages / Friends - Stubs) -->
        <main id="messages-tab" class="tab-content">
             <div class="card"><h2>üí¨ Messages (En construction)</h2><p class="muted">Cette section n'est pas encore impl√©ment√©e avec l'API.</p></div>
        </main>
        <main id="friends-tab" class="tab-content">
             <div class="card"><h2>üë• Amis (En construction)</h2><p class="muted">Cette section n'est pas encore impl√©ment√©e avec l'API.</p></div>
        </main>

        <!-- RIGHT COLUMN -->
        <aside class="right-section">
            <div class="card">
                <strong>Suggestions</strong>
                <div class="suggest" id="suggestions"></div>
            </div>

            <div class="card small">
                <strong>Raccourcis</strong>
                <div style="display:flex;flex-direction:column;gap:6px;margin-top:8px">
                    <button class="btn" onclick="seedSample()">G√©n√©rer exemple</button>
                    <button class="btn" onclick="clearAll()">R√©initialiser</button>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- VUES D'AUTHENTIFICATION (OVERLAY) -->
    <div id="auth-overlay" class="auth-overlay flex justify-center items-center">
        <!-- 1. VUE DE CONNEXION -->
        <div id="view-login" class="w-full max-w-md bg-white p-8 rounded-xl form-card card" style="display: block;">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Connexion</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email √©tudiant</label>
                    <input type="email" id="login-email" name="email" required 
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                    <input type="password" id="login-password" name="password" required 
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <button type="submit" 
                        class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 btn" style="margin-top:10px">Se Connecter</button>
            </form>
            <p class="mt-4 text-center text-sm text-gray-600">
                Pas encore de compte ? <button onclick="showAuthView('register')" class="text-indigo-600 hover:text-indigo-800 font-medium btn" style="color:#4f46e5;text-decoration:underline">Inscrivez-vous</button>
            </p>
        </div>
        
        <!-- 2. VUE D'INSCRIPTION -->
        <div id="view-register" class="w-full max-w-md bg-white p-8 rounded-xl form-card card" style="display: none;">
             <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Inscription</h2>
                <form id="register-form">
                    
                    <div class="mb-4">
                        <label for="register-first-name" class="block text-sm font-medium text-gray-700">Pr√©nom</label>
                        <input type="text" id="register-first-name" name="first_name" required 
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>
                    
                    <div class="mb-4">
                        <label for="register-last-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="register-last-name" name="last_name" required 
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>
                    
                    <div class="mb-4">
                        <label for="register-username" class="block text-sm font-medium text-gray-700">Nom d'utilisateur</label>
                        <input type="text" id="register-username" name="username" required 
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>
                    
                    <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email √©tudiant (@esme.fr)</label>
                        <input type="email" id="register-email" name="email" required 
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>

                    <div class="mb-6">
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                        <input type="password" id="register-password" name="password" required 
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>

                    <button type="submit" 
                            class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 btn" style="margin-top:10px">S'inscrire</button>
                </form>
                <p class="mt-4 text-center text-sm text-gray-600">
                    D√©j√† un compte ? <button onclick="showAuthView('login')" class="text-indigo-600 hover:text-indigo-800 font-medium btn" style="color:#4f46e5;text-decoration:underline">Connectez-vous</button>
                </p>
        </div>
    </div>

    <!-- NOTIFICATIONS PANEL -->
    <div id="notificationsPanel" style="display:none; position:fixed; top:60px; right:20px; width:350px; background:#1a2332; border:1px solid rgba(255,255,255,0.1); border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:999; max-height:400px; overflow-y:auto;">
        <div style="padding:12px; border-bottom:1px solid rgba(255,255,255,0.1);">
            <h3 style="margin:0; font-size:14px; color:#e6eef8;">üîî Notifications</h3>
        </div>
        <div id="notificationsContent" style="padding:8px;">
            <div style="text-align:center; color:var(--muted); padding:20px;">Aucune notification</div>
        </div>
    </div>

    <script>
        // =======================
        // VARIABLES & STATE API
        // =======================
        const API_BASE_URL = 'http://localhost:3000/api';
        const STORAGE_KEY = 'minireseau:v1'; // Cl√© pour les posts/amis locaux
        
        let currentUser = null; // Informations utilisateur (ID, nom, pr√©nom, etc.)
        let is_authenticated = false;
        let realFriendsCount = 0; // Nombre d'amis issus de l'API /ami/friends

        // √âl√©ments du DOM principaux
        const appWrap = document.getElementById('app-wrap');
        const authOverlay = document.getElementById('auth-overlay');
        const leftColumn = document.getElementById('left-column');
        
        // √âtat pour les posts/amis (conserv√© temporairement)
        let localState = {posts:[], friends:[], notifications:[]};
        
        // √âl√©ments du DOM pour l'affichage utilisateur
        const myNameEl = document.getElementById('myName');
        const myAvatarEl = document.getElementById('myAvatar');
        const myHandleEl = document.getElementById('myHandle');

        // ====================================================================
        // GESTION DES MESSAGES D'ERREUR/SUCC√àS
        // ====================================================================
window.goToProfile = function() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            if (!token || !user) {
                alert("Veuillez vous connecter pour acc√©der √† votre profil.");
                showAuthView("login");
                return;
            }

            // Redirection vers la page de profil (nom de fichier en fran√ßais dans le projet)
            window.location.href = "profil.html";
        };
        function showMessage(message, type = 'error') {
            const container = document.getElementById('message-container');
            const color = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
            
            // Utilisation de classes Tailwind pour la carte d'alerte
            container.innerHTML = `
                <div class="${color} border px-4 py-3 rounded-lg relative shadow-lg mb-2" role="alert">
                    <span class="block sm:inline">${message}</span>
                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="this.parentNode.remove()">
                        <svg class="fill-current h-6 w-6" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.697l-2.651 2.652a1.2 1.2 0 1 1-1.697-1.697L8.303 10 5.651 7.348a1.2 1.2 0 1 1 1.697-1.697L10 8.303l2.651-2.652a1.2 1.2 0 0 1 1.697 1.697L11.697 10l2.652 2.651a1.2 1.2 0 0 1 0 1.697z"/></svg>
                    </span>
                </div>
            `;
            setTimeout(() => {
                if (container.firstChild) {
                    container.firstChild.remove();
                }
            }, 5000);
        }

        // ====================================================================
        // GESTION DE LA VUE & NAVIGATION
        // ====================================================================
        
        /**
         * Bascule l'affichage entre les diff√©rentes vues (onglets) de l'application.
         * @param {string} tabId - L'ID de l'onglet √† afficher (ex: 'feed', 'profile').
         */
        window.showTab = function(tabId) {
            // Emp√™che l'acc√®s aux onglets si non connect√©
            if (!is_authenticated && tabId !== 'login' && tabId !== 'register') {
                showMessage("Veuillez vous connecter pour acc√©der au r√©seau.");
                showAuthView('login');
                return;
            }
            
            // Masquer tous les onglets de contenu principal
            document.querySelectorAll('.tab-content').forEach(section => {
                section.classList.remove('active');
            });
            
            // Activer l'onglet demand√©
            const targetTab = document.getElementById(`${tabId}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
            } else if (tabId === 'login' || tabId === 'register') {
                // Si c'est l'auth, on affiche juste l'overlay
                showAuthView(tabId);
                return;
            } else {
                showMessage(`L'onglet "${tabId}" n'est pas trouv√© ou n'est pas encore impl√©ment√©.`, 'error');
                return;
            }

            // Lancer l'action sp√©cifique √† l'onglet
            if (tabId === 'feed') {
                // Toujours recharger depuis l'API pour voir les vrais posts (et leurs images)
                loadFeedFromAPI();
            } else if (tabId === 'profile' && currentUser) {
                fetchUserProfile();
            }
        }
        
        /**
         * Affiche la bo√Æte de dialogue (overlay) d'authentification.
         * @param {string} viewId - 'login' ou 'register'.
         */
        function showAuthView(viewId) {
            // Masquer toutes les vues d'auth
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-register').style.display = 'none';
            
            // Afficher la vue demand√©e
            const viewElement = document.getElementById(`view-${viewId}`);
            if (viewElement) {
                viewElement.style.display = 'block';
            }
            
            // Afficher l'overlay et masquer le contenu principal
            authOverlay.style.display = 'flex';
            appWrap.style.display = 'none'; 
        }

        /**
         * Cache l'overlay d'authentification et affiche le contenu principal.
         */
        function hideAuthView() {
            authOverlay.style.display = 'none';
            appWrap.style.display = 'grid'; // Revient au layout grid principal
        }


        /**
         * Met √† jour l'√©tat de l'application (UI, variables) apr√®s connexion/d√©connexion.
         */
        function updateUI() {
            const token = localStorage.getItem('token');
            const userJson = localStorage.getItem('user');

            is_authenticated = !!token && !!userJson;
            
            if (is_authenticated) {
                try {
                    currentUser = JSON.parse(userJson);
                    
                    // Mise √† jour des infos dans la colonne de gauche
                    const fullName = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim();
                    myNameEl.innerHTML = `<strong>${fullName || currentUser.username}</strong>`;
                    myHandleEl.textContent = `@${currentUser.username} ¬∑ Membre`;
                    myAvatarEl.textContent = getInitials(fullName || currentUser.username);

                    // Afficher les colonnes lat√©rales et le wrap
                    hideAuthView(); 
                    leftColumn.style.display = 'block';
                    document.getElementById('logoutBtn').style.display = 'inline-block';
                    
                    // On force l'affichage du fil d'actu apr√®s connexion
                    showTab('feed');

                    // Synchroniser les statistiques d'amis avec l'API
                    loadFriendsStats();
                    
                    // Charger les notifications
                    loadNotifications();
                    // Actualiser toutes les 30 secondes
                    notificationsInterval = setInterval(loadNotifications, 30000);

                } catch (e) {
                    console.error("Erreur parsing user:", e);
                    logout(); // Probl√®me de donn√©es, on d√©connecte
                }
            } else {
                currentUser = null;
                
                // Afficher l'overlay de connexion/inscription
                showAuthView('login');
                
                // Masquer le contenu principal
                myNameEl.innerHTML = `<strong>Utilisateur Demo</strong>`;
                myHandleEl.textContent = `@demo ¬∑ D√©connect√©`;
                myAvatarEl.textContent = 'U?';
                leftColumn.style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';

                realFriendsCount = 0;
                updateStats();
            }
        }
        
        // ====================================================================
        // LOGIQUE D'AUTHENTIFICATION (Inscription / Connexion / D√©connexion)
        // ====================================================================

        /**
         * Gestionnaire de soumission du formulaire d'inscription.
         */
        async function handleRegister(event) {
            event.preventDefault();
            
            const form = event.target;
            const data = {
                first_name: form['register-first-name'].value, 
                last_name: form['register-last-name'].value,   
                username: form['register-username'].value,
                email: form['register-email'].value,
                password: form['register-password'].value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Inscription r√©ussie. Veuillez vous connecter.', 'success');
                    form.reset();
                    showAuthView('login');
                } else {
                    showMessage(result.error || 'Erreur lors de l\'inscription. Veuillez r√©essayer.');
                }
            } catch (error) {
                console.error('Erreur r√©seau lors de l\'inscription:', error);
                showMessage('Connexion au serveur impossible.');
            }
        }

        /**
         * Gestionnaire de soumission du formulaire de connexion.
         */
        async function handleLogin(event) {
            event.preventDefault();
            
            const form = event.target;
            const data = {
                email: form['login-email'].value,
                password: form['login-password'].value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    
                    form.reset();
                    showMessage(`Bienvenue, ${result.user.first_name || result.user.username} !`, 'success');
                    updateUI(); // Met √† jour l'UI et affiche le fil d'actu
                } else {
                    showMessage(result.error || 'Erreur de connexion. Email ou mot de passe incorrect.');
                }
            } catch (error) {
                console.error('Erreur r√©seau lors de la connexion:', error);
                showMessage('Connexion au serveur impossible.');
            }
        }

        /**
         * D√©connexion de l'utilisateur.
         * Apr√®s la d√©connexion, on retourne sur la page login.html.
         */
        window.logout = function() {
            // Arr√™ter le chargement automatique des notifications
            if (notificationsInterval) clearInterval(notificationsInterval);
            
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
        
        // ====================================================================
        // GESTION DU PROFIL UTILISATEUR (API)
        // ====================================================================

        /**
         * R√©cup√®re le profil de l'utilisateur connect√© via l'API /api/users/me.
         */
        async function fetchUserProfile() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                                const response = await fetch(`${API_BASE_URL}/users/me`, {
                                        method: 'GET',
                                        headers: { 'Authorization': `Bearer ${token}` }
                                });

                                const result = await response.json();

                if (response.ok) {
                    displayUserProfile(result.user);
                } else {
                    // Si le token est expir√©, on d√©connecte l'utilisateur
                    if (response.status === 401) {
                         showMessage("Session expir√©e. Veuillez vous reconnecter.", 'error');
                         logout();
                    } else {
                         showMessage(result.error || 'Erreur lors de la r√©cup√©ration du profil.', 'error');
                    }
                }

            } catch (error) {
                console.error('Erreur r√©seau lors de la r√©cup√©ration du profil:', error);
                showMessage('Impossible de contacter le serveur de profil.');
            }
        }

        /**
         * Met √† jour le contenu de la vue profil.
         * @param {object} user - Les donn√©es du profil utilisateur compl√®tes.
         */
        function displayUserProfile(user) {
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
            document.getElementById('profile-full-name').textContent = fullName;
            document.getElementById('profile-username').textContent = user.username;
            document.getElementById('profile-email').textContent = user.email;
            document.getElementById('profile-avatar').textContent = getInitials(fullName || user.username);
            
            // Formatage de la date de cr√©ation
            const date = new Date(user.created_at);
            document.getElementById('profile-created-at').textContent = date.toLocaleDateString('fr-FR', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
        }
        
        // ====================================================================
        // UTILITAIRES DE GESTION DU STOCKAGE LOCAL (pour les posts/amis)
        // ====================================================================
        
        // IMPORTANT : Ces fonctions utilisent encore localStorage pour simuler les posts.
        // Le compteur d'amis, lui, est d√©sormais bas√© sur l'API r√©elle /ami/friends.

        function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(localState)); updateStats(); }
        function load(){ const s = localStorage.getItem(STORAGE_KEY); if(s){ try{localState=JSON.parse(s);}catch(e){console.warn(e)} } updateStats(); }
        function updateStats(){ 
            document.getElementById('statPosts').textContent = localState.posts.length; 
            document.getElementById('statFriends').textContent = realFriendsCount; 
            document.getElementById('notifCount').textContent = localState.notifications.length; 
        }

        // Charge le nombre d'amis r√©els via l'API /ami/friends pour synchroniser avec ami.html
        async function loadFriendsStats() {
            const token = localStorage.getItem('token');
            if (!token) {
                realFriendsCount = 0;
                updateStats();
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/ami/friends`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const friends = await res.json();
                    realFriendsCount = Array.isArray(friends) ? friends.length : 0;
                } else {
                    realFriendsCount = 0;
                }
            } catch (e) {
                console.error('Erreur chargement amis (stats):', e);
                realFriendsCount = 0;
            }

            updateStats();
        }
        function uid(){ return Math.random().toString(36).slice(2,9); }
        function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        function linkify(s){ return s.replace(/(https?:\/\/[^\s]+)/g,'<a target="_blank" href="$1">$1</a>').replace(/#(\w+)/g,'<span class="pill">#$1</span>'); }
        function getInitials(name){ return name.split(' ').map(n=>n[0]).slice(0,2).join('').toUpperCase() || 'U'; }


        // Reste du code pour le feed et les actions (maintenu pour ne pas casser la timeline locale)
        // ====================================================================
        const feedEl = document.getElementById('feed');
        const composer = document.getElementById('composer');
        const publishBtn = document.getElementById('publishBtn');
        const clearBtn = document.getElementById('clearBtn');
        const suggestionsEl = document.getElementById('suggestions');
        const imageFileInput = document.getElementById('imageFileInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const removeImageBtn = document.getElementById('removeImageBtn');
        let currentImageData = null; // dataURL de l'image s√©lectionn√©e

        // Pr√©visualisation de l'image √† partir du fichier choisi
        if (imageFileInput && imagePreview && imagePreviewContainer) {
            imageFileInput.addEventListener('change', () => {
                const file = imageFileInput.files && imageFileInput.files[0];
                if (!file) {
                    currentImageData = null;
                    imagePreview.src = '';
                    imagePreviewContainer.style.display = 'none';
                    return;
                }

                // Optionnel : limiter la taille (ex. 3 Mo)
                const MAX_SIZE = 3 * 1024 * 1024;
                if (file.size > MAX_SIZE) {
                    showMessage('Image trop lourde (max 3 Mo).', 'error');
                    imageFileInput.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImageData = e.target.result;
                    imagePreview.src = currentImageData;
                    imagePreviewContainer.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            });
        }

        if (removeImageBtn && imagePreview && imagePreviewContainer && imageFileInput) {
            removeImageBtn.addEventListener('click', () => {
                currentImageData = null;
                imageFileInput.value = '';
                imagePreview.src = '';
                imagePreviewContainer.style.display = 'none';
            });
        }

        async function renderFeed(filter=""){ 
            feedEl.innerHTML='';
            let posts = localState.posts.slice().sort((a,b)=>b.ts-a.ts);
            if(filter) posts = posts.filter(p=>p.text.toLowerCase().includes(filter) || (p.authorName && p.authorName.toLowerCase().includes(filter)));
            if(posts.length===0){ document.getElementById('emptyFeed').style.display='block'; return } else document.getElementById('emptyFeed').style.display='none';
            
            for (const p of posts) {
                const el = document.createElement('article'); 
                el.className='post';
                el.id = `post-${p.id}`;
                const imageSrc = p.imageUrl || p.imageData;
                const imageHtml = imageSrc ? `<div class="post-image"><img src="${escapeHtml(imageSrc)}" alt="Photo publi√©e" loading="lazy" /></div>` : '';
                el.innerHTML = `
                    <div class="meta"><div class="avatar">${p.authorInitials||'U'}</div>
                    <div><div class="name">${escapeHtml(p.authorName||(currentUser?.first_name ? currentUser.first_name + ' ' + currentUser.last_name : currentUser?.username || 'Demo'))} <span class="small muted">${p.authorHandle||(currentUser?.username ? '@'+currentUser.username : '@demo')} ¬∑ ${new Date(p.ts).toLocaleString()}</span></div></div></div>
                    <div class="content">${linkify(escapeHtml(p.text))}</div>
                    ${imageHtml}
                    <div class="actions small">
                        <button class="btn" id="like-btn-${p.id}" onclick='toggleLikeAPI("${p.id}")'>‚ù§ <span id="like-count-${p.id}">${p.likes||0}</span></button>
                        <button class="btn" onclick='openCommentsAPI("${p.id}")'>üí¨ <span id="comment-count-${p.id}">${p.comments?.length||0}</span></button>
                        <button class="btn" onclick='sharePost("${p.id}")'>üîó Partager</button>
                        <button class="btn" onclick='deletePost("${p.id}")'>üóëÔ∏è Supprimer</button>
                    </div>
                    <div id="comments-${p.id}" style="margin-top:8px;display:none">
                        <div id="comments-list-${p.id}" style="max-height:200px;overflow-y:auto;margin-bottom:8px;"></div>
                        <div style="display:flex;gap:6px;">
                            <input type="text" id="cinput-${p.id}" class="comment-input" placeholder="Ajouter un commentaire..." style="flex:1;padding:6px;border-radius:4px;border:1px solid #ccc;font-size:12px;">
                            <button class="btn" onclick='addCommentAPI("${p.id}")' style="padding:6px 12px;font-size:12px;">Envoyer</button>
                        </div>
                    </div>
                `;
                feedEl.appendChild(el);
                
                // Charger les likes et commentaires depuis l'API
                await loadPostInteractions(p.id);
            }
        }
        
        async function loadPostInteractions(postId) {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                // Charger les likes
                const likesRes = await fetch(`${API_BASE_URL}/posts/interactions/${postId}/likes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (likesRes.ok) {
                    const likes = await likesRes.json();
                    const likeCountEl = document.getElementById(`like-count-${postId}`);
                    if (likeCountEl) likeCountEl.textContent = likes.length;
                    
                    // V√©rifier si l'utilisateur a aim√© ce post
                    const userLiked = likes.some(l => l.user_id === currentUser.id);
                    const likeBtnEl = document.getElementById(`like-btn-${postId}`);
                    if (likeBtnEl) likeBtnEl.style.color = userLiked ? '#ff1744' : 'inherit';
                }

                // Charger les commentaires
                const commentsRes = await fetch(`${API_BASE_URL}/posts/interactions/${postId}/comments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (commentsRes.ok) {
                    const comments = await commentsRes.json();
                    const commentCountEl = document.getElementById(`comment-count-${postId}`);
                    if (commentCountEl) commentCountEl.textContent = comments.length;
                    
                    const commentListEl = document.getElementById(`comments-list-${postId}`);
                    if (commentListEl) {
                        commentListEl.innerHTML = comments.map(c => `
                            <div style="background:#f5f5f5;padding:8px;border-radius:4px;margin-bottom:6px;font-size:12px;">
                                <strong>${escapeHtml(c.username)}</strong>
                                <div>${escapeHtml(c.content)}</div>
                                <div style="color:#999;font-size:10px;margin-top:4px;">${new Date(c.created_at).toLocaleString()}</div>
                                ${c.user_id === currentUser.id ? `<button class="btn" onclick='deleteCommentAPI(${c.id})' style="padding:2px 6px;font-size:10px;margin-top:4px;">Supprimer</button>` : ''}
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Erreur chargement interactions:', error);
            }
        }
        
        publishBtn.addEventListener('click', async ()=>{
            if (!is_authenticated) return showAuthView('login');

            const text = composer.value.trim(); 
            if(!text) return showMessage('Le message est vide.');
            
            try {
                // R√©cup√©rer le token
                const token = localStorage.getItem('token');
                if (!token) {
                    return showAuthView('login');
                }

                // Envoyer le post √† l'API
                const response = await fetch(`${API_BASE_URL}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ content: text, imageData: currentImageData || null })
                });

                if (!response.ok) {
                    const error = await response.json();
                    return showMessage(error.message || 'Erreur lors de la publication');
                }

                // R√©cup√©rer le post cr√©√© depuis la r√©ponse pour l'ajouter directement au state local
                const data = await response.json().catch(() => null);
                if (data && data.post) {
                    const p = data.post;
                    const mappedPost = {
                        id: p.id,
                        userId: p.user_id,
                        text: p.content,
                        ts: new Date(p.created_at).getTime(),
                        likes: 0,
                        comments: [],
                        authorName: p.username || (currentUser.first_name || currentUser.username || 'Moi'),
                        authorHandle: `@${currentUser.username || 'moi'}`,
                        authorInitials: getInitials(currentUser.first_name ? `${currentUser.first_name} ${currentUser.last_name || ''}` : currentUser.username || 'M'),
                        imageUrl: p.image_url || null,
                        imageData: p.image_data || currentImageData || null
                    };
                    // Ajouter en t√™te de liste
                    localState.posts.unshift(mappedPost);
                    save();
                }

                // Succ√®s: vider le formulaire
                composer.value = '';
                if (imageFileInput && imagePreviewContainer && imagePreview) {
                    currentImageData = null;
                    imageFileInput.value = '';
                    imagePreview.src = '';
                    imagePreviewContainer.style.display = 'none';
                }
                showMessage('Votre post a √©t√© publi√©', 'success');

                // Recharger le fil d'actualit√© apr√®s un court d√©lai (synchronisation)
                setTimeout(() => loadFeedFromAPI(), 500);

            } catch (error) {
                console.error('Erreur publication:', error);
                showMessage('Erreur de connexion au serveur');
            }
        });
        clearBtn.addEventListener('click', ()=>composer.value='');

        async function deletePost(id){
            if (!is_authenticated) {
                return showAuthView('login');
            }
            if (!confirm('Supprimer ce post ?')) return;

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    return showAuthView('login');
                }

                const response = await fetch(`${API_BASE_URL}/posts/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json().catch(() => ({}));

                if (!response.ok) {
                    return showMessage(result.message || 'Impossible de supprimer ce post.', 'error');
                }

                // Mise √† jour locale: retirer le post du state puis recharger depuis l'API
                localState.posts = localState.posts.filter(p => String(p.id) !== String(id));
                save();
                showMessage(result.message || 'Post supprim√©.', 'success');
                setTimeout(() => loadFeedFromAPI(), 300);
            } catch (error) {
                console.error('Erreur suppression post:', error);
                showMessage('Erreur de connexion au serveur lors de la suppression.', 'error');
            }
        }
        function toggleLike(id){ const p=localState.posts.find(x=>x.id===id); if(!p) return; p.likes=(p.likes||0)+1; save(); renderFeed(); }
        function openComments(id){ const cEl=document.getElementById('comments-'+id); if(!cEl) return; cEl.style.display=cEl.style.display==='none'?'block':'none'; if(cEl.innerHTML===''){ const p=localState.posts.find(x=>x.id===id); cEl.innerHTML=renderCommentsSection(p); } }
        function renderCommentsSection(post){ return `<div style="display:flex;gap:8px"><input id="cinput-${post.id}" style="flex:1;padding:8px;border-radius:8px;border:0;background:var(--glass)" placeholder="√âcrire un commentaire..." /><button class="btn" onclick='addComment("${post.id}")'>Envoyer</button></div><div style="margin-top:8px">${(post.comments||[]).map(c=>`<div class="small" style="padding:6px 0;border-top:1px dashed rgba(255,255,255,0.02)"><strong>${escapeHtml(c.author)}</strong> <span class="muted">¬∑ ${new Date(c.ts).toLocaleString()}</span><div>${escapeHtml(c.text)}</div></div>`).join('')}</div>` }
        function addComment(id){ if (!is_authenticated) return showAuthView('login'); const input=document.getElementById('cinput-'+id); if(!input) return; const text=input.value.trim(); if(!text) return; const post=localState.posts.find(p=>p.id===id); const authorName = `${currentUser.first_name} ${currentUser.last_name}`.trim() || currentUser.username; post.comments=post.comments||[]; post.comments.push({id:uid(),author:authorName,text,ts:Date.now()}); save(); renderFeed(); showMessage('Commentaire ajout√©', 'success'); }
        function sharePost(id){ const url=new URL(location.href); url.hash='post-'+id; navigator.clipboard?.writeText(url.toString()).then(()=>showMessage('Lien copi√©', 'success')); }
        function notify(msg){ localState.notifications.push({id:uid(),text:msg,ts:Date.now()}); save(); }
        
        function renderSuggestions(){ 
            suggestionsEl.innerHTML='';
            
            // Charger les amis depuis l'API
            const token = localStorage.getItem('token');
            if (!token) {
                suggestionsEl.innerHTML = '<div class="muted" style="padding:10px;">Connectez-vous pour voir les suggestions d\'amis</div>';
                return;
            }

            // R√©cup√©rer TOUS les utilisateurs ET les amis actuels
            Promise.all([
                fetch('http://localhost:3000/api/ami', {
                    headers: { 'Authorization': 'Bearer ' + token }
                }).then(res => res.json()),
                fetch('http://localhost:3000/api/ami/friends', {
                    headers: { 'Authorization': 'Bearer ' + token }
                }).then(res => res.json())
            ])
            .then(([allUsers, myFriends]) => {
                if (!Array.isArray(allUsers) || allUsers.length === 0) {
                    suggestionsEl.innerHTML = '<div class="muted" style="padding:10px;">Aucun utilisateur disponible</div>';
                    return;
                }

                // Cr√©er un Set des IDs des amis actuels pour filtrer rapidement
                const friendIds = new Set((myFriends || []).map(f => f.id));
                
                // Filtrer pour ne garder que les utilisateurs qui NE sont PAS des amis
                const suggestions = allUsers.filter(user => !friendIds.has(user.id));

                if (suggestions.length === 0) {
                    suggestionsEl.innerHTML = '<div class="muted" style="padding:10px;">Vous √™tes d√©j√† ami(e) avec tout le monde!</div>';
                    return;
                }

                // Afficher les suggestions (utilisateurs non amis)
                suggestions.slice(0, 6).forEach(user => {
                    const displayName = user.first_name && user.last_name 
                        ? `${user.first_name} ${user.last_name}` 
                        : user.username || 'Utilisateur';
                    
                    const row = document.createElement('div');
                    row.className = 'follow-row';
                    row.innerHTML = `
                        <div>
                            <strong>${displayName}</strong>
                            <div class="muted">@${user.username || 'user'}</div>
                        </div>
                        <div>
                            <button class="btn" onclick='follow("${displayName}", "${user.id}")'>Ajouter</button>
                        </div>
                    `;
                    suggestionsEl.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Erreur chargement suggestions:', error);
                suggestionsEl.innerHTML = '<div class="muted" style="padding:10px;">Erreur de chargement</div>';
            });
        }
        async function follow(name, userId){ 
            if (!is_authenticated) return showAuthView('login'); 
            
            // V√©rifier si d√©j√† ami (dans la vraie liste)
            const token = localStorage.getItem('token');
            if (!token) {
                showAuthView('login');
                return;
            }
            
            try {
                // V√©rifier si d√©j√† ami via l'API
                const friendsRes = await fetch('http://localhost:3000/api/ami/friends', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!friendsRes.ok) {
                    showMessage('Erreur de connexion', 'danger');
                    return;
                }
                
                const friends = await friendsRes.json();
                if (friends.some(f => f.id === userId)) {
                    showMessage('D√©j√† ami(e)', 'warning');
                    return;
                }
                
                // Envoyer la demande d'ami via l'API
                const addRes = await fetch('http://localhost:3000/api/ami/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ toId: userId })
                });
                
                if (!addRes.ok) {
                    showMessage('Erreur lors de l\'ajout', 'danger');
                    console.error('Erreur API:', addRes.status);
                    return;
                }
                
                showMessage('Demande d\'ami envoy√©e! üì§', 'success'); 
                
                // Recharger les suggestions apr√®s un d√©lai
                setTimeout(() => renderSuggestions(), 500);
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur r√©seau', 'danger');
            }
        }
        function seedSample(){ const samples=[{text:'Bienvenue sur MiniR√©seau ! #hello #prototype',authorName:'Alice',authorHandle:'@alice'},{text:'Un exemple de post avec un lien https://example.com',authorName:'Bob',authorHandle:'@bob'},{text:'On teste les r√©actions et commentaires. Qui veut discuter JS ? #javascript',authorName:'Carole',authorHandle:'@carole'}]; samples.forEach(s=>{ localState.posts.push(Object.assign({id:uid(),ts:Date.now()-Math.floor(Math.random()*1000*60*60),likes:Math.floor(Math.random()*8),comments:[],authorInitials:getInitials(s.authorName)},s)); }); save(); renderFeed(); }
        function clearAll(){ if(!confirm('Tout r√©initialiser (stockage local des posts/amis) ?')) return; localStorage.removeItem(STORAGE_KEY); localState={posts:[],friends:[],notifications:[]}; save(); renderFeed(); }

        document.getElementById('searchInput').addEventListener('input',(e)=>{ renderFeed(e.target.value.toLowerCase()); });

        // Charger le fil d'actualit√© depuis l'API backend
        async function loadFeedFromAPI() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/posts/timeline`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    console.error('Erreur chargement posts:', response.status);
                    return;
                }
                const posts = await response.json();
                
                // Formater les posts depuis l'API
                localState.posts = posts.map(post => ({
                    id: post.id,
                    userId: post.user_id,
                    text: post.content,
                    ts: new Date(post.created_at).getTime(),
                    likes: 0,
                    comments: [],
                    authorName: post.username || 'Utilisateur',
                    authorHandle: `@${post.username || 'user'}`,
                    authorInitials: (post.username || 'U').substring(0, 2).toUpperCase(),
                    imageUrl: post.image_url || null,
                    imageData: post.image_data || null
                }));

                renderFeed();
            } catch (error) {
                console.error('Erreur chargement fil:', error);
            }
        }
        
        // Afficher tous les posts (annule le filtre "Mes posts")
        function showAllPosts(){
            if (!is_authenticated) {
                showAuthView('login');
                return;
            }

            const emptyFeedEl = document.getElementById('emptyFeed');
            if (emptyFeedEl) {
                emptyFeedEl.textContent = 'Aucun post pour l\'instant ‚Äî soyez le premier !';
            }

            // On recharge la timeline compl√®te depuis l'API pour voir tous les posts
            loadFeedFromAPI();
        }
        /* =======================
           üî• FILTRER MES POSTS
        ======================= */
        function showMyPosts(){
            // Si pas connect√©, on ouvre la fen√™tre de connexion
            if (!is_authenticated) {
                showAuthView('login');
                return;
            }

            if (!currentUser) {
                updateUI();
                if (!currentUser) return;
            }

            const emptyFeedEl = document.getElementById('emptyFeed');

            // Filtrer les posts dont l'auteur est l'utilisateur connect√©
            // 1) Par userId (posts venant de la base)
            // 2) Ou par handle / nom (anciens posts locaux ou exemples)
            const username = (currentUser.username || '').toLowerCase();
            const fullName = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim().toLowerCase();

            const myPosts = localState.posts.filter(p => {
                const sameId = p.userId != null && currentUser.id != null && String(p.userId) === String(currentUser.id);

                const handle = (p.authorHandle || '').toLowerCase();
                const name = (p.authorName || '').toLowerCase();
                const sameHandle = username && handle === `@${username}`;
                const sameName = fullName && name.includes(fullName);

                return sameId || sameHandle || sameName;
            });

            feedEl.innerHTML = '';

            if (myPosts.length === 0) {
                if (emptyFeedEl) {
                    emptyFeedEl.textContent = "Vous n'avez encore publi√© aucun post. Publiez-en un pour le voir ici.";
                    emptyFeedEl.style.display = 'block';
                }
                return;
            }

            if (emptyFeedEl) {
                emptyFeedEl.textContent = 'Aucun post pour l\'instant ‚Äî soyez le premier !';
                emptyFeedEl.style.display = 'none';
            }

            myPosts
                .sort((a,b)=>b.ts-a.ts)
                .forEach(p => {
                    const el = document.createElement('article');
                    el.className = 'post';

                    const imageSrc = p.imageUrl || p.imageData;
                    const imageHtml = imageSrc ? `<div class="post-image"><img src="${escapeHtml(imageSrc)}" alt="Photo publi√©e" loading="lazy" /></div>` : '';

                    const authorName = p.authorName || (currentUser.first_name || currentUser.username || 'Utilisateur');
                    const authorHandle = p.authorHandle || `@${currentUser.username || 'user'}`;

                    el.innerHTML = `
                        <div class="meta"><div class="avatar">${p.authorInitials||'U'}</div>
                        <div><div class="name">${escapeHtml(authorName)} <span class="small muted">${authorHandle} ¬∑ ${new Date(p.ts).toLocaleString()}</span></div></div></div>
                        <div class="content">${linkify(escapeHtml(p.text))}</div>
                        ${imageHtml}
                        <div class="actions small">
                            <button class="btn" onclick='toggleLike("${p.id}")'>‚ù§ ${p.likes||0}</button>
                            <button class="btn" onclick='openComments("${p.id}")'>üí¨ ${p.comments?.length||0}</button>
                            <button class="btn" onclick='sharePost("${p.id}")'>üîó Partager</button>
                            <button class="btn" onclick='deletePost("${p.id}")'>üóëÔ∏è Supprimer</button>
                        </div>
                        <div id="comments-${p.id}" style="margin-top:8px;display:none"></div>
                    `;

                    feedEl.appendChild(el);
                });
        }

        // =======================
        // NOTIFICATIONS
        // =======================
        let notificationsInterval = null;

        async function loadNotifications() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const res = await fetch('http://localhost:3000/api/notifications', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!res.ok) return;
                
                const notifications = await res.json();
                
                // Mettre √† jour le compteur
                document.getElementById('notifCount').textContent = notifications.length;
                
                // Afficher le panneau avec les notifications
                const content = document.getElementById('notificationsContent');
                if (notifications.length === 0) {
                    content.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">‚úÖ Aucune nouvelle notification</div>';
                    return;
                }
                
                content.innerHTML = notifications.map(notif => {
                    const displayName = notif.first_name && notif.last_name 
                        ? `${notif.first_name} ${notif.last_name}` 
                        : notif.username;
                    
                    if (notif.type === 'friend_request') {
                        return `
                            <div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.1); background:rgba(11,132,255,0.1);">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                    <div style="width:32px; height:32px; border-radius:50%; background:${notif.avatarurl || 'linear-gradient(135deg, #0b84ff, #00d4ff)'}; background-size:cover;"></div>
                                    <div>
                                        <strong style="color:#e6eef8; font-size:13px;">${displayName}</strong>
                                        <div style="font-size:11px; color:var(--muted);">veut √™tre ton ami</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:6px;">
                                    <button class="btn" onclick="acceptFriendRequest(${notif.id})" style="flex:1; font-size:11px; padding:6px;">‚úÖ Accepter</button>
                                    <button class="btn" onclick="rejectFriendRequest(${notif.id})" style="flex:1; font-size:11px; padding:6px;">‚ùå Refuser</button>
                                </div>
                            </div>
                        `;
                    }
                    return '';
                }).join('');
            } catch (error) {
                console.error('Erreur chargement notifications:', error);
            }
        }

        async function acceptFriendRequest(friendshipId) {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const res = await fetch('http://localhost:3000/api/notifications/accept', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ friendshipId })
                });

                if (res.ok) {
                    showMessage('Demande d\'ami accept√©e! üéâ', 'success');
                    loadNotifications();
                    renderSuggestions();
                    setTimeout(() => loadFeedFromAPI(), 500);
                }
            } catch (error) {
                console.error('Erreur acceptation demande:', error);
            }
        }

        async function rejectFriendRequest(friendshipId) {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const res = await fetch('http://localhost:3000/api/notifications/reject', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ friendshipId })
                });

                if (res.ok) {
                    showMessage('Demande refus√©e.', 'info');
                    loadNotifications();
                }
            } catch (error) {
                console.error('Erreur refus demande:', error);
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                loadNotifications();
            }
        }

        // =======================
        // INITIALISATION
        // =======================
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Charger l'√©tat local (posts, amis, etc.)
            load();
            renderSuggestions();
            renderFeed();
            
            // 2. Attacher les gestionnaires d'√©v√©nements API
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            // 3. Fermer le panneau de notifications au clic ailleurs
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('notificationsPanel');
                const notifyBtn = document.getElementById('notifyBtn');
                if (!panel.contains(e.target) && !notifyBtn.contains(e.target)) {
                    panel.style.display = 'none';
                }
            });

            // 4. V√©rifier l'√©tat de l'authentification et mettre √† jour l'UI
            updateUI();
        });
    </script>
</body>
</html>
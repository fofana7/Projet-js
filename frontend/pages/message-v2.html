<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unity √âtudiants ‚Äî Messagerie v2</title>
  <style>
    :root {
      --bg: #0f1720;
      --card: #0b1220;
      --muted: #9aa4b2;
      --accent: #0b84ff;
      --success: #51cf66;
      --danger: #ff6b6b;
      --warning: #ffa94d;
      --radius: 12px;
      --gap: 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0a0e1a 0%, #0f1720 100%);
      color: #e6eef8;
    }

    .container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* TOPBAR */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      background: rgba(15, 23, 32, 0.8);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      flex-shrink: 0;
    }

    .topbar-left {
      display: flex;
      gap: 12px;
      align-items: center;
      flex: 1;
    }

    .topbar-center {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .topbar-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .btn:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.15);
      color: #e6eef8;
    }

    .btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .btn.primary:hover {
      background: #0a6fcc;
      filter: brightness(1.1);
    }

    /* TABS BAR */
    .tabs-bar {
      display: flex;
      gap: 4px;
      padding: 8px 18px;
      background: rgba(15, 23, 32, 0.4);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      overflow-x: auto;
      flex-shrink: 0;
    }

    .tab-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      transition: all 0.2s;
      position: relative;
    }

    .tab-btn:hover {
      color: #e6eef8;
      background: rgba(255,255,255,0.05);
    }

    .tab-btn.active {
      color: var(--accent);
      background: rgba(11, 132, 255, 0.1);
      border-bottom: 2px solid var(--accent);
    }

    /* MAIN LAYOUT */
    .main {
      display: flex;
      flex: 1;
      gap: 16px;
      padding: 16px 18px 18px 18px;
      overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px;
      background: rgba(11, 18, 32, 0.5);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .sidebar-header h3 {
      margin: 0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
    }

    .sidebar-header span {
      font-size: 11px;
      color: var(--muted);
    }

    .sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .conv-item {
      padding: 10px;
      margin-bottom: 6px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      position: relative;
    }

    .conv-item:hover {
      background: rgba(255,255,255,0.05);
    }

    .conv-item.active {
      background: rgba(11, 132, 255, 0.1);
      border-left-color: var(--accent);
    }

    .conv-title {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .conv-type-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      margin-left: 6px;
    }

    .conv-preview {
      font-size: 11px;
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .unread-badge {
      background: var(--danger);
      color: white;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 4px;
      min-width: 16px;
      text-align: center;
    }

    /* CHAT PANEL */
    .chat-panel {
      flex: 1;
      background: rgba(11, 18, 32, 0.5);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }

    .chat-header-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar-circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: radial-gradient(circle at 0 0, #38bdf8, #0b84ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
    }

    .chat-header .actions {
      display: flex;
      gap: 6px;
    }

    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      padding: 10px 12px;
      border-radius: 8px;
      max-width: 70%;
      word-wrap: break-word;
      font-size: 12px;
      line-height: 1.4;
    }

    .message.mine {
      background: var(--accent);
      color: white;
      align-self: flex-end;
      max-width: 70%;
    }

    .message.theirs {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      align-self: flex-start;
    }

    .message-meta {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .message-reactions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 6px;
      font-size: 12px;
    }

    .reaction {
      background: rgba(255,255,255,0.08);
      padding: 2px 6px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reaction:hover {
      background: rgba(255,255,255,0.15);
      transform: scale(1.1);
    }

    /* COMPOSER */
    .composer {
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .composer-input {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 8px 10px;
      color: #e6eef8;
      font-size: 12px;
    }

    .composer-input::placeholder {
      color: var(--muted);
    }

    .composer-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.05);
    }

    .file-input {
      display: none;
    }

    /* MODALS */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h3 {
      margin: 0 0 16px 0;
      font-size: 16px;
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      color: #e6eef8;
      font-size: 12px;
      font-family: inherit;
    }

    .form-group select {
      background-color: rgba(15, 23, 32, 0.8);
      cursor: pointer;
    }

    .form-group select option {
      background: #0f1720;
      color: #e6eef8;
      padding: 8px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.08);
    }

    .form-group select:focus {
      background-color: rgba(11, 132, 255, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .modal-actions .btn {
      flex: 1;
    }

    /* DOCUMENT CARD */
    .doc-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
      font-size: 11px;
    }

    .doc-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .doc-icon {
      font-size: 18px;
    }

    .doc-name {
      flex: 1;
      margin-left: 8px;
      font-weight: 500;
      word-break: break-all;
    }

    .doc-actions {
      display: flex;
      gap: 4px;
    }

    .doc-actions button {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 10px;
      padding: 2px 4px;
      transition: color 0.2s;
    }

    .doc-actions button:hover {
      color: var(--accent);
    }

    .doc-meta {
      color: var(--muted);
      font-size: 10px;
      margin-top: 6px;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.15);
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .main {
        gap: 12px;
      }

      .sidebar {
        width: 200px;
      }

      .message {
        max-width: 80%;
      }
    }

    @media (max-width: 768px) {
      .main {
        flex-direction: column;
        gap: 12px;
      }

      .sidebar {
        width: 100%;
        max-height: 25vh;
      }

      .message {
        max-width: 90%;
      }
    }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 40px 20px;
      font-size: 12px;
    }

    .friend-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .friend-search {
      flex: 1;
      min-width: 150px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(15,23,42,0.8);
      color: #e6eef8;
      font-size: 11px;
    }

    .friend-search::placeholder {
      color: var(--muted);
    }

    .friend-count {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }

    .friend-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      font-size: 11px;
      cursor: pointer;
      background: rgba(255,255,255,0.02);
      color: #e6eef8;
      transition: all 0.15s ease-in-out;
    }

    .friend-chip.selected {
      background: rgba(11,132,255,0.25);
      border-color: var(--accent);
      color: #e6f4ff;
    }

    /* Notifications toast en haut √† droite */
    .toast {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1000;
      padding: 8px 12px;
      border-radius: 8px;
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      max-width: 260px;
    }

    .toast.success {
      background: linear-gradient(135deg,#16a34a,#22c55e);
    }

    .toast.error {
      background: linear-gradient(135deg,#ef4444,#b91c1c);
    }

    .toast.info {
      background: linear-gradient(135deg,#0b84ff,#2563eb);
    }
  </style>
</head>
<body>
  <script>
    const THEME_STORAGE_KEY = 'selectedTheme';
    const saved = localStorage.getItem(THEME_STORAGE_KEY) || 'dark';
    if (saved === 'light') {
      document.body.classList.add('theme-light');
    }
  </script>
  <div id="toast" class="toast" style="display:none;"></div>
  <div class="container">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-left">
        <button class="btn" onclick="goBack()">‚Üê Retour</button>
        <strong style="font-size: 14px;">Messagerie Unity √âtudiants</strong>
      </div>
      <div class="topbar-right">
        <span style="font-size: 11px; color: var(--muted);" id="userInfo"></span>
      </div>
    </div>

    <!-- TABS (annonces d√©plac√©es vers le dashboard enseignant) -->
    <div class="tabs-bar">
      <button class="tab-btn active" onclick="switchTab('all')">üí¨ Tous</button>
      <button class="tab-btn" onclick="switchTab('private')">üí≠ Priv√©s</button>
      <button class="tab-btn" onclick="switchTab('groups')">üë• Groupes</button>
      <button class="tab-btn" onclick="switchTab('forum')">‚ùì Forum</button>
      <button class="tab-btn" onclick="switchTab('docs')">üìÑ Docs</button>
      <button class="tab-btn" onclick="switchTab('events')">üìÖ √âv√©nements</button>
      <button class="tab-btn" onclick="switchTab('polls')">üìä Sondages</button>
    </div>

    <!-- QUICK ACTIONS (sans annonce rapide, g√©r√©e c√¥t√© dashboard enseignant) -->
    <div style="display:flex; gap:8px; padding:8px 18px 0 18px; flex-wrap:wrap;">
      <button class="btn" style="font-size:11px; padding:4px 10px;" onclick="openModal('newConvModal')">üí¨ Nouveau priv√©</button>
      <button class="btn" style="font-size:11px; padding:4px 10px;" onclick="openModal('newConvModal'); document.getElementById('convType').value='group'; updateConvForm();">üë• Nouveau groupe</button>
      <button class="btn" style="font-size:11px; padding:4px 10px;" onclick="shareDoc()">üìé Partager un document</button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
      <!-- SIDEBAR -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h3>Conversations</h3>
          <button class="btn" onclick="openModal('newConvModal')" style="padding: 4px 8px;">‚ûï</button>
        </div>
        <div class="sidebar-list" id="sidebarList"></div>
      </div>

      <!-- CHAT PANEL -->
      <div class="chat-panel">
        <div class="chat-header">
          <div class="chat-header-main">
            <div class="avatar-circle" id="chatAvatar">MR</div>
            <div>
              <h2 id="chatTitle">S√©lectionner une conversation</h2>
              <div style="font-size: 11px; color: var(--muted); margin-top: 2px;" id="chatInfo"></div>
            </div>
          </div>
          <div class="actions">
            <button class="btn" onclick="shareDoc()">üìé Fichier</button>
            <button class="btn" onclick="openGroupMembers()">üë• Groupe</button>
            <button class="btn" onclick="toggleInfo()">‚ÑπÔ∏è Info</button>
          </div>
        </div>

        <div class="messages-area" id="messagesArea">
          <div class="empty">üëã S√©lectionne une conversation pour commencer</div>
        </div>

        <div class="composer">
          <textarea id="messageInput" class="composer-input" placeholder="√âcris un message..." style="resize: none; min-height: 32px; max-height: 100px;"></textarea>
          <button class="btn primary" onclick="sendMessage()" style="padding: 8px 16px; height: 32px;">Envoyer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW CONVERSATION MODAL -->
  <div class="modal" id="newConvModal">
    <div class="modal-content">
      <h3>üìù Nouvelle Conversation</h3>
      <div class="form-group">
        <label>Type *</label>
        <select id="convType" onchange="updateConvForm()">
          <option value="private">üí¨ Message Priv√©</option>
          <option value="group">üë• Groupe</option>
          <option value="thread">üí≠ Discussion</option>
        </select>
      </div>

      <div id="privateForm">
        <div class="form-group">
          <label>Avec qui? *</label>
          <input type="text" id="privateName" placeholder="Recherche un ami..." oninput="filterPrivateFriends()">
          <div id="privateFriendsSuggestions" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;"></div>
        </div>
      </div>

      <div id="groupForm" style="display:none;">
        <div class="form-group">
          <label>Nom du groupe *</label>
          <input type="text" id="groupName" placeholder="Ex: Projet Math">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="groupDesc" placeholder="Objectif du groupe..."></textarea>
        </div>
        <div class="form-group">
          <label>Membres √† inviter (amis)</label>
          <input type="text" id="groupMembers" placeholder="S√©lectionne dans ta liste d'amis" readonly>
          <div class="friend-toolbar">
            <input type="text" id="groupFriendsSearch" class="friend-search" placeholder="Rechercher un ami...">
            <span id="groupFriendsCount" class="friend-count">0 ami s√©lectionn√©</span>
          </div>
          <div id="groupFriendsSuggestions" style="margin-top:2px; display:flex; flex-wrap:wrap;"></div>
        </div>
      </div>

      <div id="threadForm" style="display:none;">
        <div class="form-group">
          <label>Sujet *</label>
          <input type="text" id="threadSubject" placeholder="Ex: Chapitre 5 - Questions">
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" onclick="closeModal('newConvModal')">Annuler</button>
        <button class="btn primary" onclick="createConversation()">Cr√©er</button>
      </div>
      <div id="convMessage" style="margin-top: 8px; text-align: center; font-size: 11px;"></div>
    </div>
  </div>

  <!-- NEW EVENT MODAL -->
  <div class="modal" id="eventModal">
    <div class="modal-content">
      <h3>üìÖ Nouvel √©v√®nement</h3>
      <div class="form-group">
        <label>Titre *</label>
        <input type="text" id="eventTitle" placeholder="Ex: R√©union Projet, Tournoi, Sortie...">
      </div>
      <div class="form-group">
        <label>Date & heure *</label>
        <input type="datetime-local" id="eventDate">
      </div>
      <div class="form-group">
        <label>Lieu</label>
        <input type="text" id="eventPlace" placeholder="Salle, visio, adresse...">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="eventDesc" placeholder="D√©tails importants, programme..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('eventModal')">Annuler</button>
        <button class="btn primary" onclick="submitEvent()">Cr√©er</button>
      </div>
      <div id="eventMessage" style="margin-top: 8px; text-align: center; font-size: 11px;"></div>
    </div>
  </div>

  <!-- ANNOUNCEMENT MODAL -->
  <div class="modal" id="announcementModal">
    <div class="modal-content">
      <h3>üì¢ Publier une annonce</h3>
      <div class="form-group">
        <label>Titre *</label>
        <input type="text" id="announcementTitle" placeholder="Titre de l'annonce...">
      </div>
      <div class="form-group">
        <label>Classe *</label>
        <select id="announcementClass">
          <option value="">-- Toutes les classes --</option>
          <option value="A1">A1</option>
          <option value="A2">A2</option>
          <option value="A3">A3</option>
        </select>
      </div>
      <div class="form-group">
        <label>Contenu *</label>
        <textarea id="announcementContent" placeholder="Contenu de l'annonce..." style="height: 120px;"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('announcementModal')">Annuler</button>
        <button class="btn primary" onclick="submitAnnouncement()">Publier</button>
      </div>
      <div id="announcementMessage" style="margin-top: 8px; text-align: center; font-size: 11px;"></div>
    </div>
  </div>

  <!-- GROUP MEMBERS MODAL -->
  <div class="modal" id="groupMembersModal">
    <div class="modal-content">
      <h3>üë• Membres du groupe</h3>
      <div id="groupMembersList" style="margin-bottom: 10px; font-size: 12px;"></div>

      <div class="form-group">
        <label>Ajouter un membre</label>
        <input type="text" id="newMemberName" placeholder="Nom ou pseudo √† ajouter">
      </div>

      <div class="modal-actions">
        <button class="btn" onclick="closeModal('groupMembersModal')">Fermer</button>
        <button class="btn primary" onclick="addGroupMember()">Ajouter</button>
        <button class="btn" style="background: #ef4444; color: white;" onclick="leaveCurrentGroup()">üëã Quitter le groupe</button>
      </div>
      <div id="groupMembersMessage" style="margin-top: 8px; text-align: center; font-size: 11px;"></div>
    </div>
  </div>

  <div class="modal" id="shareDocModal">
    <div class="modal-content">
      <h3>üìé Partager un Fichier</h3>
      <div class="form-group">
        <label>Type de fichier *</label>
        <select id="docType">
          <option value="pdf">üìÑ PDF</option>
          <option value="image">üñºÔ∏è Image</option>
          <option value="video">üé• Vid√©o</option>
          <option value="audio">üéµ Audio</option>
          <option value="document">üìù Document</option>
          <option value="other">üì¶ Autre</option>
        </select>
      </div>

      <div class="form-group">
        <label>Nom du fichier *</label>
        <input type="text" id="docName" placeholder="Ex: R√©sum√©_Chapitre5.pdf">
      </div>

      <div class="form-group">
        <label>URL/Lien *</label>
        <input type="url" id="docUrl" placeholder="https://... (optionnel si fichier local)">
      </div>

      <div class="form-group">
        <label>Depuis votre ordinateur</label>
        <button type="button" class="btn" style="font-size:11px; padding:4px 8px;" onclick="document.getElementById('fileInput').click()">Choisir un fichier...</button>
        <div id="localFileInfo" style="margin-top:4px; font-size:11px; color: var(--muted);"></div>
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea id="docDesc" placeholder="√Ä quoi √ßa sert?"></textarea>
      </div>

      <div class="form-group">
        <label>Taille (en MB)</label>
        <input type="number" id="docSize" min="0" step="0.1" placeholder="5.2">
      </div>

      <div class="modal-actions">
        <button class="btn" onclick="closeModal('shareDocModal')">Annuler</button>
        <button class="btn primary" onclick="submitShareDoc()">Partager</button>
      </div>
      <div id="docMessage" style="margin-top: 8px; text-align: center; font-size: 11px;"></div>
    </div>
  </div>

  <input type="file" id="fileInput" class="file-input" onchange="handleFileUpload()">

  <script>
    // ========================================
    // CONSTANTS & STATE
    // ========================================
    const STORAGE_KEY = 'minireseau_v2_messages';

    let state = loadState();
    let currentConvId = null;
    let currentTab = 'all';
    let searchQuery = '';
    let pendingFile = null;

    // Liste d'amis r√©cup√©r√©e depuis l'API /api/ami/friends
    let friendsForMessaging = [];
    let selectedGroupFriendIds = new Set();
    let groupFriendsSearchQuery = '';

    // ========================================
    // NOTIFICATIONS (TOAST)
    // ========================================
    function showToast(message, type = 'info') {
      const el = document.getElementById('toast');
      if (!el) return;
      el.textContent = message;
      el.className = 'toast ' + type;
      el.style.display = 'block';
      if (showToast._timer) clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => {
        el.style.display = 'none';
      }, 4000);
    }

    // ========================================
    // STATE MANAGEMENT
    // ========================================
    function loadState() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          console.error('State load error:', e);
        }
      }

      const user = (() => {
        try {
          const u = JSON.parse(localStorage.getItem('user') || 'null');
          return u || { id: uid(), username: 'Utilisateur', role: 'eleve' };
        } catch {
          return { id: uid(), username: 'Utilisateur', role: 'eleve' };
        }
      })();

      return {
        me: user,
        conversations: [],
        archived: [],
        blocked: [],
        settings: {
          notifications: true,
          darkMode: true,
          unreadBadge: true
        }
      };
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function uid() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ========================================
    // UI FUNCTIONS
    // ========================================
    function openModal(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add('active');

      // Quand on ouvre la cr√©ation de conversation, charger les amis
      if (id === 'newConvModal') {
        loadFriendsForMessaging().then(() => {
          const typeSel = document.getElementById('convType');
          if (typeSel && typeSel.value === 'private') {
            filterPrivateFriends();
          } else if (typeSel && typeSel.value === 'group') {
            renderGroupFriendSuggestions();
          }
        });
      }
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function formatTime(ts) {
      const date = new Date(ts);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return '√† l\'instant';
      if (diff < 3600000) return `il y a ${Math.floor(diff / 60000)}m`;
      if (diff < 86400000) return `il y a ${Math.floor(diff / 3600000)}h`;
      if (diff < 604800000) return date.toLocaleDateString();
      return date.toLocaleDateString();
    }

    function getFileIcon(type) {
      const icons = {
        pdf: 'üìÑ',
        image: 'üñºÔ∏è',
        video: 'üé•',
        audio: 'üéµ',
        document: 'üìù',
        other: 'üì¶'
      };
      return icons[type] || 'üì¶';
    }

    function getFriendDisplayName(friend) {
      if (!friend) return '';
      if (friend.first_name || friend.last_name) {
        return [friend.first_name || '', friend.last_name || ''].join(' ').trim();
      }
      return friend.username || friend.email || 'Ami';
    }

    function normalizeName(name) {
      return (name || '').trim().toLowerCase();
    }

    // ========================================
    // TAB MANAGEMENT
    // ========================================
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.textContent.includes('Tous') && tab === 'all'
        || b.textContent.includes('Priv√©s') && tab === 'private'
        || b.textContent.includes('Groupes') && tab === 'groups'
        || b.textContent.includes('Forum') && tab === 'forum'
        || b.textContent.includes('Docs') && tab === 'docs'
        || b.textContent.includes('√âv√©nements') && tab === 'events'
        || b.textContent.includes('Sondages') && tab === 'polls');
      if (btn) btn.classList.add('active');
      if (tab === 'events') {
        openModal('eventModal');
      }
      renderSidebar();
    }

    // ========================================
    // CONVERSATION FUNCTIONS
    // ========================================
    async function createConversation() {
      const type = document.getElementById('convType').value;
      let conv;

      if (type === 'private') {
        const name = document.getElementById('privateName').value.trim();
        if (!name) {
          showMessage('convMessage', '‚ùå Nom requis', 'var(--danger)');
          return;
        }

        // Chercher le contact dans les amis charg√©s
        let contactFound = null;
        
        // D'abord chercher une correspondance exacte (insensible √† la casse)
        contactFound = friendsForMessaging.find(f => 
          normalizeName(getFriendDisplayName(f)) === normalizeName(name)
        );

        // Si pas de correspondance exacte, chercher une correspondance partielle
        if (!contactFound) {
          contactFound = friendsForMessaging.find(f => 
            getFriendDisplayName(f).toLowerCase().includes(name.toLowerCase())
          );
        }

        if (!contactFound) {
          showMessage('convMessage', `‚ùå "${name}" n'est pas dans tes amis. Assurez-vous d'√™tre amis d'abord.`, 'var(--danger)');
          return;
        }

        const displayName = getFriendDisplayName(contactFound);
        conv = {
          id: 'db_' + contactFound.id,
          type: 'private',
          title: displayName,
          members: [state.me.username, displayName],
          messages: [],
          createdAt: Date.now(),
          unread: 0,
          contactId: contactFound.id
        };
      } else if (type === 'group') {
        const name = document.getElementById('groupName').value.trim();
        const desc = document.getElementById('groupDesc').value.trim();
        
        if (!name) {
          showMessage('convMessage', '‚ùå Nom requis', 'var(--danger)');
          return;
        }

        // Obtenir les IDs des membres s√©lectionn√©s
        const memberIds = Array.from(selectedGroupFriendIds).map(id => parseInt(id));

        // Cr√©er le groupe dans la base de donn√©es
        const token = localStorage.getItem('token');
        try {
          const res = await fetch('http://localhost:3000/api/ami/groups/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              name: name,
              description: desc,
              memberIds: memberIds
            })
          });

          if (!res.ok) {
            const error = await res.json();
            showMessage('convMessage', `‚ùå Erreur: ${error.error || 'Impossible de cr√©er le groupe'}`, 'var(--danger)');
            return;
          }

          const groupData = await res.json();
          console.log('‚úì Groupe cr√©√©:', groupData);

          // Cr√©er l'objet conversation local avec les bonnes donn√©es
          let members = [state.me.username];
          // Ajouter les noms des membres s√©lectionn√©s
          for (const id of selectedGroupFriendIds) {
            const friend = friendsForMessaging.find(f => f.id === parseInt(id));
            if (friend) {
              members.push(getFriendDisplayName(friend));
            }
          }

          conv = {
            id: 'group_' + groupData.groupId,
            type: 'group',
            title: name,
            description: desc,
            members: members,
            messages: [],
            createdAt: Date.now(),
            unread: 0,
            groupId: groupData.groupId
          };
        } catch (error) {
          console.error('Erreur cr√©ation groupe:', error);
          showMessage('convMessage', `‚ùå Erreur r√©seau: ${error.message}`, 'var(--danger)');
          return;
        }
      } else if (type === 'thread') {
        const subject = document.getElementById('threadSubject').value.trim();
        if (!subject) {
          showMessage('convMessage', '‚ùå Sujet requis', 'var(--danger)');
          return;
        }
        conv = {
          id: uid(),
          type: 'thread',
          title: subject,
          messages: [],
          createdAt: Date.now(),
          unread: 0
        };
      }

      state.conversations.unshift(conv);
      saveState();
      showMessage('convMessage', '‚úì Cr√©√©e!', 'var(--success)');
      
      setTimeout(() => {
        closeModal('newConvModal');
        renderSidebar();
        openConversation(conv.id);
        clearForm();
        // Recharger les groupes depuis la DB pour s'assurer que tout est √† jour
        if (type === 'group') {
          loadConversationsFromDB();
        }
      }, 600);
    }

    function submitEvent() {
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const place = document.getElementById('eventPlace').value.trim();
      const desc = document.getElementById('eventDesc').value.trim();
      const msgEl = document.getElementById('eventMessage');

      if (!title || !date) {
        msgEl.textContent = '‚ùå Titre et date requis';
        msgEl.style.color = 'var(--danger)';
        return;
      }

      const conv = {
        id: uid(),
        type: 'events',
        title,
        event: {
          date,
          place,
          desc
        },
        messages: [],
        createdAt: Date.now(),
        unread: 0
      };

      state.conversations.unshift(conv);
      saveState();
      msgEl.textContent = '‚úì √âv√®nement cr√©√©!';
      msgEl.style.color = 'var(--success)';

      setTimeout(() => {
        document.getElementById('eventTitle').value = '';
        document.getElementById('eventDate').value = '';
        document.getElementById('eventPlace').value = '';
        document.getElementById('eventDesc').value = '';
        closeModal('eventModal');
        renderSidebar();
        openConversation(conv.id);
      }, 700);
    }

    async function submitAnnouncement() {
      const title = document.getElementById('announcementTitle').value.trim();
      const content = document.getElementById('announcementContent').value.trim();
      const className = document.getElementById('announcementClass').value || null;
      const msgEl = document.getElementById('announcementMessage');

      if (!title || !content) {
        msgEl.textContent = '‚ùå Titre et contenu requis';
        msgEl.style.color = 'var(--danger)';
        return;
      }

      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      try {
        const res = await fetch('http://localhost:3000/api/content/announcements', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            title,
            content,
            author: user.username || 'Enseignant',
            class_name: className
          })
        });

        if (!res.ok) {
          const err = await res.json();
          msgEl.textContent = '‚ùå ' + (err.error || 'Erreur serveur');
          msgEl.style.color = 'var(--danger)';
          return;
        }

        msgEl.textContent = '‚úì Annonce publi√©e!';
        msgEl.style.color = 'var(--success)';

        setTimeout(() => {
          document.getElementById('announcementTitle').value = '';
          document.getElementById('announcementContent').value = '';
          document.getElementById('announcementClass').value = '';
          closeModal('announcementModal');
        }, 700);
      } catch (e) {
        console.error('Erreur publication annonce:', e);
        msgEl.textContent = '‚ùå Erreur r√©seau';
        msgEl.style.color = 'var(--danger)';
      }
    }

    async function loadAndDisplayAnnouncements() {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const res = await fetch('http://localhost:3000/api/content/announcements', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          console.warn('Impossible de charger les annonces');
          return;
        }

        const data = await res.json();
        const announcements = data.announcements || [];
        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');

        // Afficher les annonces dans le chat panel
        const chatPanel = document.querySelector('.chat-panel');
        if (!chatPanel) return;

        let html = '<div style="padding: 16px; overflow-y: auto;">';
        html += '<h2 style="margin-top: 0;">üì¢ Annonces</h2>';

        if (announcements.length === 0) {
          html += '<p style="color: var(--muted); text-align: center; padding: 20px;">Aucune annonce pour le moment</p>';
        } else {
          announcements.forEach(ann => {
            const date = new Date(ann.created_at).toLocaleDateString('fr-FR', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            // Montrer le bouton seulement si c'est l'auteur
            const isAuthor = ann.author_id && parseInt(ann.author_id) === parseInt(currentUser.id);
            const deleteBtn = isAuthor ? `<button class="btn" onclick="deleteAnnouncement(${ann.id})" style="padding: 6px 10px; margin-left: 8px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; white-space: nowrap;">üóëÔ∏è Supprimer</button>` : '';
            
            html += `
              <div style="background: var(--bg-light); border-left: 4px solid var(--primary); padding: 12px; margin-bottom: 12px; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                  <div style="flex: 1; min-width: 0;">
                    <h4 style="margin: 0 0 8px 0; color: var(--text);">${escapeHtml(ann.title)}</h4>
                    <p style="margin: 0 0 8px 0; color: var(--text); font-size: 13px;">${escapeHtml(ann.content)}</p>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                      <span>Par ${escapeHtml(ann.author || 'Enseignant')}</span>
                      <span>${date}</span>
                    </div>
                    ${ann.class_name ? `<div style="font-size: 11px; color: var(--muted); margin-top: 6px;">üìö Classe: <strong>${escapeHtml(ann.class_name)}</strong></div>` : ''}
                  </div>
                  ${deleteBtn}
                </div>
              </div>
            `;
          });
        }
        html += '</div>';

        chatPanel.innerHTML = html;

        // Changer le titre du chat
        const chatHeader = document.querySelector('.chat-header h2');
        if (chatHeader) chatHeader.textContent = 'üì¢ Annonces';
      } catch (e) {
        console.error('Erreur chargement annonces:', e);
      }
    }

    async function deleteAnnouncement(announcementId) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette annonce?')) return;

      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const res = await fetch(`http://localhost:3000/api/content/announcements/${announcementId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          const err = await res.json();
          showToast('‚ùå ' + (err.error || 'Erreur lors de la suppression'), 'error');
          return;
        }

        showToast('‚úì Annonce supprim√©e', 'success');
        loadAndDisplayAnnouncements();
      } catch (e) {
        console.error('Erreur suppression annonce:', e);
        showToast('‚ùå Erreur r√©seau', 'error');
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    async function openConversation(convId) {
      const conv = state.conversations.find(c => c.id === convId);
      if (!conv) return;

      currentConvId = convId;
      conv.unread = 0;

      // Charger les messages depuis la base de donn√©es si conversation priv√©e
      if (conv.type === 'private') {
        await loadMessagesFromDB(conv);
      }

      renderSidebar();
      renderChat(conv);
      saveState();
    }

    async function loadMessagesFromDB(conv) {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        // Si on a le contactId (depuis la DB), l'utiliser directement
        if (conv.contactId) {
          const messagesRes = await fetch(`http://localhost:3000/api/messages/${conv.contactId}`, {
            headers: { 'Authorization': 'Bearer ' + token }
          });

          if (!messagesRes.ok) return;

          const messages = await messagesRes.json();
          const recipientName = conv.members.find(m => m !== state.me.username);
          
          // Convertir les messages de la DB au format de l'app
          conv.messages = messages.map(msg => ({
            id: msg.id,
            author: msg.sender_id === state.me.id ? state.me.username : recipientName,
            authorId: msg.sender_id,
            text: msg.text,
            ts: new Date(msg.created_at).getTime(),
            reactions: {},
            read: msg.is_read
          }));

          saveState();
          return;
        }

        // Sinon, chercher le contact par son nom
        const recipientName = conv.members.find(m => m !== state.me.username);
        if (!recipientName) return;

        // R√©cup√©rer l'ID du contact
        const contactsRes = await fetch('http://localhost:3000/api/messages/contacts', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (!contactsRes.ok) return;

        const contacts = await contactsRes.json();
        const recipient = contacts.find(c => c.username === recipientName);

        if (!recipient) return;

        // Stocker le contactId pour les appels futurs
        conv.contactId = recipient.id;

        // R√©cup√©rer les messages
        const messagesRes = await fetch(`http://localhost:3000/api/messages/${recipient.id}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!messagesRes.ok) return;

        const messages = await messagesRes.json();
        
        // Convertir les messages de la DB au format de l'app
        conv.messages = messages.map(msg => ({
          id: msg.id,
          author: msg.sender_id === state.me.id ? state.me.username : recipientName,
          authorId: msg.sender_id,
          text: msg.text,
          ts: new Date(msg.created_at).getTime(),
          reactions: {},
          read: msg.is_read
        }));

        saveState();
      } catch (error) {
        console.error('Erreur chargement messages DB:', error);
      }
    }

    function renderSidebar() {
      const list = document.getElementById('sidebarList');
      list.innerHTML = '';

      // Filtrer par tab (type logique)
      let convs = state.conversations;
      if (currentTab !== 'all') {
        if (currentTab === 'groups') {
          convs = convs.filter(c => c.type === 'group');
        } else if (currentTab === 'forum') {
          convs = convs.filter(c => c.type === 'thread');
        } else if (currentTab === 'docs') {
          convs = convs.filter(c => c.messages.some(m => m.file));
        } else if (currentTab === 'events') {
          convs = convs.filter(c => c.type === 'events');
        } else {
          convs = convs.filter(c => c.type === currentTab);
        }
      }

      // Filtrer par recherche
      if (searchQuery) {
        convs = convs.filter(c => c.title.toLowerCase().includes(searchQuery.toLowerCase()));
      }

      if (convs.length === 0) {
        list.innerHTML = '<div class="empty" style="padding: 20px;">Aucune conversation</div>';
        return;
      }

      convs.forEach(conv => {
        const div = document.createElement('div');
        div.className = `conv-item ${conv.id === currentConvId ? 'active' : ''}`;
        div.onclick = () => openConversation(conv.id);

        const title = document.createElement('div');
        title.className = 'conv-title';
        title.innerHTML = conv.title;

        // Chip de type (ic√¥ne)
        const typeChip = document.createElement('span');
        typeChip.className = 'conv-type-chip';
        const typeIcon = {
          private: 'üí¨',
          group: 'üë•',
          thread: '‚ùì',
          docs: 'üìÑ',
          events: 'üìÖ',
          board: 'üì¢',
          polls: 'üìä'
        }[conv.type] || 'üí¨';
        typeChip.textContent = typeIcon;
        title.prepend(typeChip);

        if (conv.unread > 0) {
          const badge = document.createElement('span');
          badge.className = 'unread-badge';
          badge.textContent = conv.unread > 9 ? '9+' : conv.unread;
          title.appendChild(badge);
        }

        const preview = document.createElement('div');
        preview.className = 'conv-preview';
        if (conv.type === 'events' && conv.event) {
          const d = new Date(conv.event.date);
          const dateStr = isNaN(d.getTime()) ? '' : d.toLocaleString();
          const place = conv.event.place ? ` ‚Ä¢ ${conv.event.place}` : '';
          preview.textContent = `üìÖ ${dateStr}${place}` || (conv.description || '√âv√®nement');
        } else if (conv.messages.length > 0) {
          const last = conv.messages[conv.messages.length - 1];
          const label = last.text || (last.file && last.file.name) || '[Fichier]';
          preview.textContent = `${last.author}: ${label.slice(0, 40)}...`;
        } else {
          preview.textContent = conv.description || 'Aucun message';
        }

        div.appendChild(title);
        div.appendChild(preview);
        list.appendChild(div);
      });
    }

    function renderChat(conv) {
      document.getElementById('chatTitle').textContent = conv.title;

      let info;
      if (conv.type === 'private') {
        info = `Avec ${conv.members.find(m => m !== state.me.username)}`;
      } else if (conv.type === 'group') {
        const members = conv.members || [];
        info = `${members.length} membre${members.length > 1 ? 's' : ''}`;
        const others = members.filter(m => m !== state.me.username);
        if (others.length) {
          const sample = others.slice(0, 3).join(', ');
          info += ` ‚Ä¢ ${sample}${others.length > 3 ? '...' : ''}`;
        }
      } else if (conv.type === 'events' && conv.event) {
        const d = new Date(conv.event.date);
        const dateStr = isNaN(d.getTime()) ? '' : d.toLocaleString();
        const place = conv.event.place ? ` ‚Ä¢ ${conv.event.place}` : '';
        info = `${dateStr}${place}` || `√âv√®nement cr√©√© ${formatTime(conv.createdAt)}`;
      } else {
        info = `Discussion lanc√©e ${formatTime(conv.createdAt)}`;
      }
      document.getElementById('chatInfo').textContent = info;

      // Avatar (initiales du titre)
      const avatar = document.getElementById('chatAvatar');
      if (avatar) {
        const title = (conv.title || '').trim();
        const parts = title.split(' ');
        const initials = (parts[0]?.[0] || 'M') + (parts[1]?.[0] || 'R');
        avatar.textContent = initials.toUpperCase();
      }

      const area = document.getElementById('messagesArea');
      area.innerHTML = '';

      // Carte r√©cap pour les √©v√®nements
      if (conv.type === 'events' && conv.event) {
        const card = document.createElement('div');
        card.className = 'doc-card';
        card.style.marginBottom = '12px';

        const d = new Date(conv.event.date);
        const dateStr = isNaN(d.getTime()) ? 'Date √† pr√©ciser' : d.toLocaleString();
        const place = conv.event.place ? ` ‚Ä¢ ${conv.event.place}` : '';
        const desc = conv.event.desc || 'Aucun d√©tail suppl√©mentaire';

        const rsvp = (conv.event.rsvp || {})[state.me.id];
        let statusLabel = '';
        if (rsvp === 'yes') statusLabel = '‚úÖ Tu participes √† cet √©v√®nement';
        else if (rsvp === 'no') statusLabel = '‚ùå Tu as indiqu√© ne pas venir';

        card.innerHTML = `
          <div class="doc-header">
            <span class="doc-icon">üìÖ</span>
            <span class="doc-name">${dateStr}${place}</span>
          </div>
          <div class="doc-meta">${desc}</div>
        `;

        const actions = document.createElement('div');
        actions.className = 'doc-actions';
        const yesBtn = document.createElement('button');
        yesBtn.textContent = 'Je participe';
        yesBtn.onclick = () => setEventRsvp(conv.id, 'yes');
        const noBtn = document.createElement('button');
        noBtn.textContent = 'Je ne peux pas';
        noBtn.onclick = () => setEventRsvp(conv.id, 'no');
        actions.appendChild(yesBtn);
        actions.appendChild(noBtn);
        card.appendChild(actions);

        if (statusLabel) {
          const status = document.createElement('div');
          status.className = 'doc-meta';
          status.textContent = statusLabel;
          card.appendChild(status);
        }

        area.appendChild(card);
      }

      if (conv.messages.length === 0) {
        area.innerHTML += '<div class="empty">Sois le premier √† envoyer un message!</div>';
        return;
      }

      conv.messages.forEach((msg, idx) => {
        const div = document.createElement('div');
        div.className = `message ${msg.authorId === state.me.id ? 'mine' : 'theirs'}`;

        if (msg.text) {
          const text = document.createElement('div');
          text.textContent = msg.text;
          div.appendChild(text);
        }

        if (msg.file) {
          const file = document.createElement('div');
          file.className = 'doc-card';
          file.style.cssText = 'background: rgba(255,255,255,0.08); border: 1px solid rgba(11,132,255,0.3); margin-top: 6px;';
          file.innerHTML = `
            <div class="doc-header">
              <span class="doc-icon">${getFileIcon(msg.file.type)}</span>
              <span class="doc-name" title="${msg.file.name}">${msg.file.name}</span>
            </div>
            <div class="doc-meta">
              ${msg.file.size ? msg.file.size + ' MB ‚Ä¢ ' : ''}Partag√© par ${msg.author}
            </div>
          `;

          // Actions ouvrir / t√©l√©charger
          if (msg.file.url || msg.file.dataUrl) {
            const actions = document.createElement('div');
            actions.className = 'doc-actions';
            if (msg.file.url) {
              const openLink = document.createElement('a');
              openLink.href = msg.file.url;
              openLink.target = '_blank';
              openLink.textContent = 'Ouvrir';
              openLink.style.color = 'inherit';
              actions.appendChild(openLink);
            }
            if (msg.file.dataUrl) {
              const downloadLink = document.createElement('a');
              downloadLink.href = msg.file.dataUrl;
              downloadLink.download = msg.file.name || 'fichier';
              downloadLink.textContent = 'T√©l√©charger';
              downloadLink.style.color = 'inherit';
              actions.appendChild(downloadLink);
            }
            file.appendChild(actions);
          }
          div.appendChild(file);
        }

        if (msg.reactions && Object.keys(msg.reactions).length > 0) {
          const reactions = document.createElement('div');
          reactions.className = 'message-reactions';
          Object.entries(msg.reactions).forEach(([emoji, count]) => {
            const span = document.createElement('span');
            span.className = 'reaction';
            span.textContent = `${emoji} ${count}`;
            span.onclick = (e) => {
              e.stopPropagation();
              addReaction(conv.id, idx, emoji);
            };
            reactions.appendChild(span);
          });
          div.appendChild(reactions);
        }

        const meta = document.createElement('div');
        meta.className = 'message-meta';
        meta.textContent = `${msg.author} ‚Ä¢ ${formatTime(msg.ts)}`;
        div.appendChild(meta);

        area.appendChild(div);
      });

      area.scrollTop = area.scrollHeight;
    }

    async function sendMessage() {
      const text = document.getElementById('messageInput').value.trim();
      if (!text || !currentConvId) return;

      const conv = state.conversations.find(c => c.id === currentConvId);
      if (!conv) return;

      // Pour les conversations priv√©es, envoyer via l'API
      if (conv.type === 'private') {
        const recipientName = conv.members.find(m => m !== state.me.username);
        if (!recipientName) return;

        const token = localStorage.getItem('token');
        if (!token) return;

        try {
          // Chercher l'ID de l'utilisateur par son username
          const contactsRes = await fetch('http://localhost:3000/api/messages/contacts', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          if (!contactsRes.ok) {
            console.error('Erreur lors de la r√©cup√©ration des contacts');
            return;
          }

          const contacts = await contactsRes.json();
          const recipient = contacts.find(c => c.username === recipientName);

          if (!recipient) {
            showToast('Destinataire non trouv√© dans les contacts', 'error');
            return;
          }

          // Envoyer le message via l'API
          const sendRes = await fetch('http://localhost:3000/api/messages/send', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              recipientId: recipient.id,
              text: text,
              fileUrl: null
            })
          });

          if (!sendRes.ok) {
            console.error('Erreur envoi message:', sendRes.status);
            showToast('Erreur lors de l\'envoi du message', 'error');
            return;
          }
        } catch (error) {
          console.error('Erreur envoi message:', error);
          showToast('Erreur r√©seau lors de l\'envoi du message', 'error');
          return;
        }
      }

      // Pour toutes les conversations (priv√©es, groupes, threads), ajouter localement
      conv.messages.push({
        id: uid(),
        author: state.me.username,
        authorId: state.me.id,
        text,
        ts: Date.now(),
        reactions: {},
        read: true
      });

      document.getElementById('messageInput').value = '';
      saveState();
      renderChat(conv);
      renderSidebar();
    }

    function addReaction(convId, msgIdx, emoji) {
      const conv = state.conversations.find(c => c.id === convId);
      if (!conv || !conv.messages[msgIdx]) return;

      const msg = conv.messages[msgIdx];
      msg.reactions = msg.reactions || {};
      msg.reactions[emoji] = (msg.reactions[emoji] || 0) + 1;

      saveState();
      renderChat(conv);
    }

    function shareDoc() {
      if (!currentConvId) {
        showToast('‚ö†Ô∏è S√©lectionne une conversation d\'abord', 'info');
        return;
      }
      // Ouvre directement la modal; l'utilisateur peut soit coller un lien, soit choisir un fichier local
      openModal('shareDocModal');
    }

    function submitShareDoc() {
      const type = document.getElementById('docType').value;
      const name = document.getElementById('docName').value.trim();
      const url = document.getElementById('docUrl').value.trim();
      const desc = document.getElementById('docDesc').value.trim();
      const size = parseFloat(document.getElementById('docSize').value) || 0;
      const msgBox = document.getElementById('docMessage');

      if (!name && !pendingFile) {
        showMessage('docMessage', '‚ùå Nom requis (ou choisissez un fichier)', 'var(--danger)');
        return;
      }
      if (!url && !pendingFile) {
        showMessage('docMessage', '‚ùå Fournissez un lien ou un fichier local', 'var(--danger)');
        return;
      }

      const conv = state.conversations.find(c => c.id === currentConvId);
      if (!conv) return;

      const finalize = () => {
        saveState();
        showMessage('docMessage', '‚úì Fichier partag√©!', 'var(--success)');

        setTimeout(() => {
          closeModal('shareDocModal');
          clearForm();
          renderChat(conv);
          renderSidebar();
        }, 800);
      };

      // Cas fichier local (pendingFile)
      if (pendingFile) {
        msgBox.textContent = 'Envoi du fichier...';
        msgBox.style.color = 'var(--muted)';
        const file = pendingFile;
        const reader = new FileReader();
        reader.onload = (e) => {
          conv.messages.push({
            id: uid(),
            author: state.me.username,
            authorId: state.me.id,
            file: {
              name: name || file.name,
              type,
              desc,
              size: size || +(file.size / 1024 / 1024).toFixed(1),
              dataUrl: e.target.result
            },
            ts: Date.now(),
            reactions: {},
            read: true
          });
          finalize();
        };
        reader.readAsDataURL(file);
      } else {
        // Cas lien externe
        conv.messages.push({
          id: uid(),
          author: state.me.username,
          authorId: state.me.id,
          file: {
            name,
            type,
            url,
            desc,
            size
          },
          ts: Date.now(),
          reactions: {},
          read: true
        });
        finalize();
      }
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function showMessage(elementId, text, color) {
      const el = document.getElementById(elementId);
      if (el) {
        el.textContent = text;
        el.style.color = color;
      }
    }

    function clearForm() {
      document.getElementById('privateName').value = '';
      document.getElementById('groupName').value = '';
      document.getElementById('groupDesc').value = '';
      const gm = document.getElementById('groupMembers');
      if (gm) gm.value = '';
      document.getElementById('threadSubject').value = '';
      document.getElementById('docName').value = '';
      document.getElementById('docUrl').value = '';
      document.getElementById('docDesc').value = '';
      document.getElementById('docSize').value = '';
      pendingFile = null;
      const info = document.getElementById('localFileInfo');
      if (info) info.textContent = '';
      const input = document.getElementById('fileInput');
      if (input) input.value = '';
    }

    function updateConvForm() {
      const type = document.getElementById('convType').value;
      document.getElementById('privateForm').style.display = type === 'private' ? 'block' : 'none';
      document.getElementById('groupForm').style.display = type === 'group' ? 'block' : 'none';
      document.getElementById('threadForm').style.display = type === 'thread' ? 'block' : 'none';

      if (type === 'private') {
        filterPrivateFriends();
      } else if (type === 'group') {
        renderGroupFriendSuggestions();
      }
    }

    function filterPrivateFriends() {
      const input = document.getElementById('privateName');
      const container = document.getElementById('privateFriendsSuggestions');
      if (!container || !input) return;

      const query = (input.value || '').toLowerCase().trim();
      container.innerHTML = '';

      if (!friendsForMessaging || friendsForMessaging.length === 0) {
        container.innerHTML = '<span style="font-size:11px; color: var(--muted);">Aucun ami trouv√©.</span>';
        return;
      }

      // Filtrer les amis selon la recherche
      const filtered = friendsForMessaging.filter(friend => {
        const name = getFriendDisplayName(friend).toLowerCase();
        const email = (friend.email || '').toLowerCase();
        if (!query) return true;
        return name.includes(query) || email.includes(query);
      });

      if (filtered.length === 0) {
        container.innerHTML = '<span style="font-size:11px; color: var(--muted);">Aucun ami ne correspond.</span>';
        return;
      }

      // Afficher les suggestions
      filtered.forEach(friend => {
        const name = getFriendDisplayName(friend);
        const chip = document.createElement('div');
        chip.className = 'friend-chip';
        chip.textContent = name;
        chip.style.cursor = 'pointer';
        chip.onclick = () => {
          input.value = name;
          filterPrivateFriends();
        };
        container.appendChild(chip);
      });
    }

    function toggleInfo() {
      const count = (state.conversations.find(c => c.id === currentConvId)?.messages.length || 0);
      showToast('‚ÑπÔ∏è Infos conversation ‚Äî ID: ' + currentConvId + ' ‚Äî Messages: ' + count, 'info');
    }

    function setEventRsvp(convId, status) {
      const conv = state.conversations.find(c => c.id === convId);
      if (!conv || conv.type !== 'events') return;
      conv.event = conv.event || {};
      conv.event.rsvp = conv.event.rsvp || {};
      conv.event.rsvp[state.me.id] = status;
      saveState();
      if (convId === currentConvId) {
        renderChat(conv);
      }
    }

    function openGroupMembers() {
      const conv = state.conversations.find(c => c.id === currentConvId);
      if (!conv || conv.type !== 'group') {
        showToast('Cette gestion est disponible uniquement pour les conversations de type groupe.', 'info');
        return;
      }
      renderGroupMembers(conv);
      showMessage('groupMembersMessage', '', '');
      openModal('groupMembersModal');
    }

    function renderGroupMembers(conv) {
      const container = document.getElementById('groupMembersList');
      if (!container) return;
      const meName = state.me.username;
      container.innerHTML = '';

      if (!conv.members || conv.members.length === 0) {
        container.innerHTML = '<div class="empty" style="padding:10px;">Aucun membre pour l\'instant</div>';
        return;
      }

      conv.members.forEach((name, idx) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.marginBottom = '4px';

        const span = document.createElement('span');
        span.textContent = name === meName ? name + ' (toi)' : name;
        row.appendChild(span);

        if (name !== meName) {
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.style.fontSize = '10px';
          btn.style.padding = '2px 6px';
          btn.textContent = 'Retirer';
          btn.onclick = () => removeGroupMember(idx);
          row.appendChild(btn);
        }

        container.appendChild(row);
      });
    }

    function addGroupMember() {
      const input = document.getElementById('newMemberName');
      const name = (input?.value || '').trim();
      if (!name) {
        showMessage('groupMembersMessage', '‚ùå Entrez un nom √† ajouter', 'var(--danger)');
        return;
      }
      const conv = state.conversations.find(c => c.id === currentConvId);
      if (!conv || conv.type !== 'group') return;

      // On n'autorise que des amis existants pour la synchro
      const match = friendsForMessaging.find(f => normalizeName(getFriendDisplayName(f)) === normalizeName(name));
      if (!match) {
        showMessage('groupMembersMessage', '‚ö†Ô∏è Ce nom ne correspond √† aucun de tes amis', 'var(--danger)');
        return;
      }

      const displayName = getFriendDisplayName(match);

      conv.members = conv.members || [];
      if (conv.members.map(m => normalizeName(m)).includes(normalizeName(displayName))) {
        showMessage('groupMembersMessage', '‚ö†Ô∏è Ce membre est d√©j√† dans le groupe', 'var(--warning)');
        return;
      }

      conv.members.push(displayName);
      saveState();
      renderGroupMembers(conv);
      renderChat(conv);
      input.value = '';
      showMessage('groupMembersMessage', '‚úì Membre ajout√©', 'var(--success)');
    }

    async function leaveCurrentGroup() {
      const conv = state.conversations.find(c => c.id === currentConvId);
      if (!conv || conv.type !== 'group') {
        showToast('‚ùå Impossible de quitter: pas de groupe s√©lectionn√©', 'error');
        return;
      }

      if (!confirm(`√ätes-vous s√ªr de vouloir quitter le groupe "${conv.name}"?`)) return;

      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_BASE}/api/ami/groups/leave`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ groupId: conv.id })
        });

        if (!res.ok) {
          const error = await res.json();
          showToast('‚ùå Erreur: ' + (error.message || 'Impossible de quitter le groupe'), 'error');
          return;
        }

        showToast('‚úì Vous avez quitt√© le groupe', 'success');
        closeModal('groupMembersModal');
        
        // Supprimer la conversation de la liste
        state.conversations = state.conversations.filter(c => c.id !== currentConvId);
        saveState();
        currentConvId = null;
        
        // Recharger les conversations
        renderConversations();
        renderChat(null);
      } catch (e) {
        console.error('Erreur:', e);
        showToast('‚ùå Erreur r√©seau', 'error');
      }
    }

    function removeGroupMember(index) {
      const conv = state.conversations.find(c => c.id === currentConvId);
      if (!conv || conv.type !== 'group' || !conv.members) return;
      if (index < 0 || index >= conv.members.length) return;

      const removed = conv.members.splice(index, 1)[0];
      saveState();
      renderGroupMembers(conv);
      renderChat(conv);
      showMessage('groupMembersMessage', `Membre retir√©: ${removed}`, 'var(--muted)');
    }

    function goBack() {
  window.location.href = '../../index.html';
    }

    function handleFileUpload() {
      const input = document.getElementById('fileInput');
      if (!input || !input.files || !input.files[0]) return;
      const file = input.files[0];
      pendingFile = file;

      const nameEl = document.getElementById('docName');
      const sizeEl = document.getElementById('docSize');
      const info = document.getElementById('localFileInfo');
      if (nameEl) nameEl.value = file.name;
      if (sizeEl) sizeEl.value = (file.size / 1024 / 1024).toFixed(1);
      if (info) info.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)} Mo)`;

      // D√©tecter automatiquement le type
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      let detected = 'other';
      if (['pdf'].includes(ext)) detected = 'pdf';
      else if (['png','jpg','jpeg','gif','webp'].includes(ext)) detected = 'image';
      else if (['mp4','mov','avi','mkv','webm'].includes(ext)) detected = 'video';
      else if (['mp3','wav','ogg'].includes(ext)) detected = 'audio';
      else if (['doc','docx','odt','txt','ppt','pptx'].includes(ext)) detected = 'document';
      const typeSelect = document.getElementById('docType');
      if (typeSelect) typeSelect.value = detected;

      openModal('shareDocModal');
    }

    // Charger les amis depuis l'API pour la messagerie (synchronis√© avec ami.html)
    async function loadFriendsForMessaging() {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const res = await fetch('http://localhost:3000/api/messages/contacts', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) {
          console.warn('Impossible de charger les contacts pour la messagerie:', res.status);
          return;
        }
        const data = await res.json();
        friendsForMessaging = Array.isArray(data) ? data : [];
        // Ne garde dans la s√©lection que les IDs encore valides
        selectedGroupFriendIds = new Set(
          Array.from(selectedGroupFriendIds).filter(id =>
            friendsForMessaging.some(f => f.id === id)
          )
        );
        renderGroupFriendSuggestions();
      } catch (e) {
        console.error('Erreur chargement contacts messagerie:', e);
      }
    }

    function renderGroupFriendSuggestions() {
      const container = document.getElementById('groupFriendsSuggestions');
      const input = document.getElementById('groupMembers');
      const searchInput = document.getElementById('groupFriendsSearch');
      const countLabel = document.getElementById('groupFriendsCount');
      if (!container || !input) return;
      
      if (searchInput && searchInput.oninput == null) {
        searchInput.oninput = (e) => {
          groupFriendsSearchQuery = (e.target.value || '').toLowerCase();
          renderGroupFriendSuggestions();
        };
      }

      container.innerHTML = '';
      selectedGroupFriendIds = new Set(selectedGroupFriendIds); // s'assurer que c'est un Set

      if (!friendsForMessaging || friendsForMessaging.length === 0) {
        container.innerHTML = '<span style="font-size:11px; color: var(--muted);">Aucun ami trouv√© pour l‚Äôinstant.</span>';
        input.value = '';
        if (countLabel) countLabel.textContent = '0 ami s√©lectionn√©';
        return;
      }

      // Appliquer la recherche
      const filtered = friendsForMessaging.filter(friend => {
        const name = getFriendDisplayName(friend).toLowerCase();
        const email = (friend.email || '').toLowerCase();
        if (!groupFriendsSearchQuery) return true;
        return name.includes(groupFriendsSearchQuery) || email.includes(groupFriendsSearchQuery);
      });

      if (filtered.length === 0) {
        container.innerHTML = '<span style="font-size:11px; color: var(--muted);">Aucun ami ne correspond √† cette recherche.</span>';
      }

      filtered.forEach(friend => {
        const name = getFriendDisplayName(friend);
        const chip = document.createElement('div');
        chip.className = 'friend-chip' + (selectedGroupFriendIds.has(friend.id) ? ' selected' : '');
        chip.textContent = name;
        chip.onclick = () => {
          if (selectedGroupFriendIds.has(friend.id)) {
            selectedGroupFriendIds.delete(friend.id);
          } else {
            selectedGroupFriendIds.add(friend.id);
          }
          // Mettre √† jour l'affichage et le champ de membres
          const names = friendsForMessaging
            .filter(f => selectedGroupFriendIds.has(f.id))
            .map(f => getFriendDisplayName(f));
          input.value = names.join(', ');
          renderGroupFriendSuggestions();
        };
        container.appendChild(chip);
      });

      // Mettre √† jour le compteur
      if (countLabel) {
        const count = selectedGroupFriendIds.size;
        countLabel.textContent = count + ' ami' + (count > 1 ? 's s√©lectionn√©s' : ' s√©lectionn√©');
      }
    }

    // R√©cup√®re l'utilisateur courant depuis localStorage.user
    function getSessionUser() {
      try {
        const raw = localStorage.getItem('user');
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || !parsed.id) return null;
        return {
          id: parsed.id,
          username: parsed.username || 'Utilisateur',
          role: parsed.role || 'eleve'
        };
      } catch (e) {
        console.warn('Impossible de lire la session utilisateur pour la messagerie:', e);
        return null;
      }
    }

    // ========================================
    // INITIALIZATION
    // ========================================
    const API_BASE = 'http://localhost:3000';
    
    function init() {
      // V√©rifier qu'une session existe, sinon renvoyer vers la page de connexion
      const token = localStorage.getItem('token');
      const storedUser = localStorage.getItem('user');
      if (!token || !storedUser) {
        window.location.href = '../login.html';
        return;
      }

      // Synchroniser l'utilisateur de la messagerie avec l'utilisateur r√©ellement connect√©
      const sessionUser = getSessionUser();
      if (sessionUser) {
        if (!state.me) state.me = {};
        state.me.id = sessionUser.id;
        state.me.username = sessionUser.username;
        state.me.role = sessionUser.role;
        saveState();
      }

      const userInfoEl = document.getElementById('userInfo');
      if (userInfoEl && state.me) {
        userInfoEl.textContent = state.me.role
          ? `${state.me.username} (${state.me.role})`
          : state.me.username;
      }
      
      // Charger les conversations depuis la DB
      loadConversationsFromDB();
      renderSidebar();

      // Enter key for message
      document.getElementById('messageInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Charger les amis r√©els pour la cr√©ation / gestion de groupes
      loadFriendsForMessaging();
    }

    async function loadConversationsFromDB() {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        // R√©cup√©rer toutes les conversations de l'utilisateur
        const convRes = await fetch('http://localhost:3000/api/messages/conversations', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!convRes.ok) {
          console.warn('Impossible de charger les conversations depuis la DB');
          return;
        }

        const conversations = await convRes.json();
        
        // Convertir les conversations de la DB au format de l'app
        const dbConversations = conversations.map(conv => ({
          id: 'db_' + conv.other_user_id,
          type: 'private',
          title: conv.username,
          members: [state.me.username, conv.username],
          avatar: conv.avatarurl,
          messages: [],
          createdAt: Date.now(),
          unread: conv.unread_count || 0,
          lastMessage: conv.last_message,
          lastMessageTime: conv.last_message_time,
          contactId: conv.other_user_id // Stocker l'ID du contact pour les requ√™tes futures
        }));

        // Charger les groupes depuis le backend (seulement ceux dont l'utilisateur est membre)
        const groupsRes = await fetch('http://localhost:3000/api/ami/groups', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        let groupConversations = [];
        if (groupsRes.ok) {
          const groups = await groupsRes.json();
          
          // Pour chaque groupe, charger les membres
          for (const group of groups) {
            let members = [];
            try {
              const membersRes = await fetch(`http://localhost:3000/api/ami/groups/${group.id}/members`, {
                headers: { 'Authorization': 'Bearer ' + token }
              });
              if (membersRes.ok) {
                const membersList = await membersRes.json();
                members = membersList.map(m => m.username);
              }
            } catch (e) {
              console.warn('Impossible de charger les membres du groupe:', e);
            }
            
            groupConversations.push({
              id: 'group_' + group.id,
              type: 'group',
              title: group.name,
              members: members,
              description: group.description,
              messages: [],
              createdAt: Date.now(),
              groupId: group.id,
              memberCount: group.memberCount || 0
            });
          }
        }

        // Remplacer compl√®tement l'√©tat avec les conversations v√©rifi√©es du backend
        state.conversations = [...dbConversations, ...groupConversations];
        saveState();
        renderSidebar();
      } catch (error) {
        console.error('Erreur chargement conversations DB:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

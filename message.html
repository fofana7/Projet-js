<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniR√©seau √âtudiants ‚Äî Messagerie multim√©dia</title>
<style>
:root{
  --bg:#0f1720; --card:#0b1220; --muted:#9aa4b2; --accent:#0b84ff; --glass: rgba(255,255,255,0.03);
  --radius:12px; --gap:14px; font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%, #081827 100%);color:#e6eef8}
.app{max-width:1100px;margin:28px auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:14px;overflow:hidden;box-shadow:0 6px 28px rgba(2,6,23,0.6)}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.03);gap:12px}
.topbar .left{display:flex;gap:12px;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
.btn.primary{background:var(--accent);border-color:transparent;color:white}
.nav{display:flex;gap:12px;margin-top:10px;margin-bottom:10px}
.nav button.active{background:var(--accent);color:white}
.content{display:flex;gap:16px;padding:16px}
.sidebar{width:280px;max-height:70vh;overflow:auto;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.card{padding:12px;border-radius:12px;background:var(--card)}
.conv{display:flex;justify-content:space-between;gap:10px;padding:10px;border-radius:10px;align-items:center;cursor:pointer;transition:0.2s}
.conv:hover{background:rgba(255,255,255,0.02)}
.avatar{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;background:linear-gradient(180deg,#0b84ff22,#4ab3ff11);color:#fff}
.conv strong{display:block}
.conv .text{font-size:13px;color:var(--muted);max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conv .right{text-align:right;min-width:60px}
.unread-badge{background:#ff5b5b;padding:3px 6px;border-radius:999px;color:white;font-size:12px;animation:pulse 1s infinite alternate;}
@keyframes pulse{from{opacity:0.8}to{opacity:1}}
.main{flex:1;display:flex;flex-direction:column;max-height:70vh}
.chat-header{padding:12px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
.chat-header .info{display:flex;gap:12px;align-items:center}
.chat-header .title{font-size:16px;font-weight:600}
.chat-header .status{font-size:12px;color:lime}
.messages-list{padding:14px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:6px}
.msg{max-width:72%;padding:12px;border-radius:12px;background:var(--glass);line-height:1.35;position:relative;transition:0.1s;word-break:break-word}
.msg:hover{transform:translateY(-1px)}
.msg.me{margin-left:auto;background:linear-gradient(90deg, rgba(11,132,255,0.16), rgba(11,132,255,0.08));}
.msg .meta{font-size:13px;color:var(--muted);margin-bottom:6px}
.msg .meta span{margin-left:6px;font-size:11px;color:var(--muted)}
.composer-row{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,0.02);align-items:end}
.composer-row textarea{flex:1;padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.02);color:inherit;min-height:44px;resize:none}
.composer-row input[type=file]{display:none}
.file-btn{border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:10px;color:var(--muted);cursor:pointer;background:transparent}
.empty{text-align:center;padding:28px;color:var(--muted)}
img.chat-image{max-width:200px;border-radius:10px;margin-top:6px}
 a.chat-file{display:block;color:var(--accent);text-decoration:underline;margin-top:4px}
 @media (max-width:900px){.content{flex-direction:column}.sidebar{width:100%;max-height:36vh}.main{max-height:48vh}}
 
 /* Modal styles */
 .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:2000}
 .modal.active{display:flex}
 .modal-content{background:var(--card);padding:24px;border-radius:16px;max-width:500px;width:90%;max-height:80vh;overflow:auto;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
 .modal-content h3{margin-top:0;color:var(--accent)}
 .modal-content label{display:block;margin-top:12px;margin-bottom:6px;font-weight:600;font-size:14px;color:#e6eef8}
 .modal-content input[type="text"],.modal-content input[type="url"],.modal-content textarea{width:100%;padding:10px;margin:5px 0 12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:inherit;border-radius:8px;box-sizing:border-box}
 .modal-content input:focus,.modal-content textarea:focus{outline:none;border-color:var(--accent);background:rgba(11,132,255,0.1)}
 .modal-content textarea{min-height:100px;resize:vertical}
 .modal-content .form-group{margin-bottom:16px}
 .modal-actions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}
 .modal-actions button{flex:1;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:0.2s}
 .modal-actions .btn-submit{background:var(--accent);color:white}
 .modal-actions .btn-submit:hover{background:#0a6fcc}
 .modal-actions .btn-cancel{background:rgba(255,255,255,0.1);color:var(--muted)}
 .modal-actions .btn-cancel:hover{background:rgba(255,255,255,0.15)}
 
 /* Document list styles */
 .doc-item{background:rgba(11,132,255,0.08);padding:12px;border-radius:10px;margin-bottom:10px;border-left:3px solid var(--accent)}
 .doc-item-title{font-weight:600;color:#e6eef8;margin-bottom:6px}
 .doc-item-meta{font-size:12px;color:var(--muted);margin-bottom:8px}
 .doc-item-desc{font-size:13px;color:#b0b8c4;margin-bottom:10px}
 .doc-item-actions{display:flex;gap:6px;flex-wrap:wrap}
 .doc-item-actions a{font-size:12px;padding:6px 10px;background:var(--accent);color:white;border-radius:6px;text-decoration:none;cursor:pointer;border:none}
 .doc-item-actions a:hover{background:#0a6fcc}
 </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="left">
      <button class="btn" onclick="window.location.href='index.html'">‚Üê Retour</button>
      <strong>MiniR√©seau √âtudiants</strong>
      <span id="currentUserDisplay" style="margin-left:12px;color:var(--muted);font-weight:600"></span>
    </div>
    <div class="nav">
      <button id="tabPrivate" class="active">Messagerie priv√©e</button>
      <button id="tabGroup">Groupes / Projets</button>
      <button id="tabForum">Forum Q&R</button>
      <button id="tabDocs">Partage docs</button>
      <button id="tabEvents">√âv√©nements</button>
      <button id="tabBoard">Annonces</button>
      <button id="tabPolls">Sondages</button>
    </div>
  </div>

  <div class="content">
    <div class="sidebar card" id="sidebar">S√©lectionner une conversation</div>
    <div class="main card">
      <div class="chat-header">
        <div class="info">
          <div class="avatar" id="chatAvatar">U</div>
          <div>
            <div class="title" id="chatTitle">S√©lectionner une conversation</div>
            <div class="status" id="chatStatus">‚Äî</div>
          </div>
        </div>
      </div>
      <div class="messages-list" id="messagesList">
        <div class="empty">Aucune conversation s√©lectionn√©e</div>
      </div>
      <div class="composer-row">
        <textarea id="messageInput" placeholder="√âcrire un message..." rows="1"></textarea>
        <label class="file-btn" for="fileInput">üìé</label>
        <input type="file" id="fileInput">
        <button class="btn primary" id="sendBtn">Envoyer</button>
      </div>
    </div>
  </div>
</div>

<!-- Document Sharing Modal -->
<div class="modal" id="docModal">
  <div class="modal-content">
    <h3>Partager un document</h3>
    <div class="form-group">
      <label for="docTitle">Titre du document *</label>
      <input type="text" id="docTitle" placeholder="Ex: R√©sum√© de Math√©matiques" required>
    </div>
    <div class="form-group">
      <label for="docUrl">URL du document *</label>
      <input type="url" id="docUrl" placeholder="Ex: https://drive.google.com/..." required>
    </div>
    <div class="form-group">
      <label for="docDesc">Description (optionnel)</label>
      <textarea id="docDesc" placeholder="D√©crivez bri√®vement le contenu..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeDocModal()">Annuler</button>
      <button class="btn-submit" onclick="submitDoc()">Partager</button>
    </div>
    <div id="docModalMessage" style="margin-top:12px; font-size:13px;"></div>
  </div>
</div>

<script>
// ========================================
// CONFIG & STATE
// ========================================
const API_URL = 'http://localhost:3000/api';
const STORAGE_KEY = 'minireseau_etudiants_multimedia';
const storedAppUser = (() => { try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){ return null } })();

function computeDisplayName(appUser){
  if(!appUser) return 'Utilisateur Demo';
  const first = (appUser.first_name||'').trim(); const last = (appUser.last_name||'').trim();
  if(first || last) return `${first} ${last}`.trim();
  if(appUser.username) return appUser.username;
  if(appUser.email) return (appUser.email||'').split('@')[0];
  return 'Utilisateur';
}

const defaultMe = storedAppUser ? { id: storedAppUser.id || 'me', name: computeDisplayName(storedAppUser) } : { id: 'me', name: 'Utilisateur Demo' };
let state = JSON.parse(localStorage.getItem(STORAGE_KEY)||JSON.stringify({"me":defaultMe,"private":[], "groups":[], "forum":[], "docs":[], "events":[], "announcements":[], "polls":[]}));
let currentTab = 'private';
let currentId = null;
let friends = []; // Stockage des amis depuis l'API

const sidebar=document.getElementById('sidebar');
const messagesList=document.getElementById('messagesList');
const chatTitle=document.getElementById('chatTitle');
const chatStatus=document.getElementById('chatStatus');
const chatAvatar=document.getElementById('chatAvatar');
const messageInput=document.getElementById('messageInput');
const fileInput=document.getElementById('fileInput');

const tabPrivate=document.getElementById('tabPrivate');
const tabGroup=document.getElementById('tabGroup');
const tabForum=document.getElementById('tabForum');

const uid=()=>crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2,9);
const initials=n=>(n||'U').split(' ').map(p=>p[0]).join('').slice(0,2).toUpperCase();
const safeText=t=>{const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
const formatRelative=ts=>{const d=(Date.now()-ts)/1000;if(d<60)return"√† l‚Äôinstant";if(d<3600)return Math.round(d/60)+" min";if(d<86400)return Math.round(d/3600)+" h";return new Date(ts).toLocaleString();}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}

// ---------- SEED EXEMPLE ----------
function seedExample(){
  if(state.private.length===0){
    state.private.push({
      id:uid(), title:'Alice', participants:['Alice', state.me.name],
      messages:[
        {id:uid(), author:'Alice', authorId:'alice', text:'Salut !', ts:Date.now()-3600000, read:false},
        {id:uid(), author:state.me.name, authorId:state.me.id, text:'Salut Alice, comment √ßa va ?', ts:Date.now()-3500000, read:true},
        {id:uid(), author:'Alice', authorId:'alice', dataUrl:'https://via.placeholder.com/150', fileName:'photo.png', ts:Date.now()-3400000, read:false}
      ], lastTs:Date.now()-3400000
    });
  }
  if(state.groups.length===0){
    state.groups.push({
      id:uid(), title:'Projet X', participants:[state.me.name,'Bob','Charlie'],
      messages:[
        {id:uid(), author:'Bob', authorId:'bob', text:'Bonjour √† tous', ts:Date.now()-1800000, read:false},
        {id:uid(), author:'Charlie', authorId:'charlie', text:'Salut, je commence √† travailler sur la partie front', ts:Date.now()-1700000, read:false}
      ], lastTs:Date.now()-1700000
    });
  }
  if(state.forum.length===0){
    state.forum.push({
      id:uid(), title:'Math√©matiques 101',
      messages:[
        {id:uid(), author:'Prof', authorId:'prof', text:'Bienvenue sur le forum', ts:Date.now()-7200000, read:false}
      ], lastTs:Date.now()-7200000
    });
  }
  save();
}

// ========================================
// LOAD FRIENDS FROM API
// ========================================
async function loadFriendsFromAPI() {
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      console.warn('No token. Using demo friends.');
      return;
    }
    
    const response = await fetch(`${API_URL}/ami`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (response.ok) {
      friends = await response.json();
      console.log(`‚úì Loaded ${friends.length} friends from API`);
      
      // Create private conversations for each friend
      friends.forEach(friend => {
        const convId = 'private-' + friend.id;
        if (!state.private.find(c => c.id === convId)) {
          state.private.push({
            id: convId,
            title: friend.username || 'Unknown',
            friendId: friend.id,
            friendData: friend,
            participants: [friend.username || 'Unknown', state.me.name],
            messages: [],
            lastTs: Date.now()
          });
        }
      });
      save();
    }
  } catch (error) {
    console.error('Failed to load friends:', error);
  }
}

// ---------- RENDER SIDEBAR ----------
function renderSidebar(){
  sidebar.innerHTML='';
  // Header action per tab
  const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center'; header.style.marginBottom='8px';
  const htitle = document.createElement('div'); htitle.textContent = currentTab==='private' ? 'Conversations priv√©es' : currentTab==='groups' ? 'Groupes / Projets' : currentTab==='forum' ? 'Forum' : currentTab==='docs' ? 'Documents partag√©s' : currentTab==='events' ? '√âv√©nements' : currentTab==='board' ? 'Annonces' : currentTab==='polls' ? 'Sondages' : '';
  header.appendChild(htitle);
  const action = document.createElement('div');
  if(currentTab==='private'){ 
    const b=document.createElement('button'); b.textContent='‚ûï Nouveau'; b.className='btn'; b.onclick=openNewConversationModal; action.appendChild(b); 
  }
  if(currentTab==='docs'){ const b=document.createElement('button'); b.textContent='Ajouter doc'; b.className='btn'; b.onclick=createDocPrompt; action.appendChild(b); }
  if(currentTab==='events'){ const b=document.createElement('button'); b.textContent='Cr√©er √©v√©nement'; b.className='btn'; b.onclick=createEventPrompt; action.appendChild(b); }
  if(currentTab==='board'){ const b=document.createElement('button'); b.textContent='Publier annonce'; b.className='btn'; b.onclick=createAnnouncementPrompt; action.appendChild(b); }
  if(currentTab==='polls'){ const b=document.createElement('button'); b.textContent='Cr√©er sondage'; b.className='btn'; b.onclick=createPollPrompt; action.appendChild(b); }
  header.appendChild(action);
  sidebar.appendChild(header);

  let list=[];
  if(currentTab==='private') list=state.private;
  if(currentTab==='groups') list=state.groups;
  if(currentTab==='forum') list=state.forum;
  if(currentTab==='docs') list=state.docs;
  if(currentTab==='events') list=state.events;
  if(currentTab==='board') list=state.announcements;
  if(currentTab==='polls') list=state.polls;

  if(!list || list.length===0){ sidebar.innerHTML += '<div class="empty">Aucun √©l√©ment</div>'; return; }

  list.forEach(c=>{
    const div=document.createElement('div'); div.className='conv'; div.dataset.id=c.id;
    const av=document.createElement('div'); av.className='avatar'; av.textContent=initials(c.title || c.question || c.title || (c.name||'N'));
    const txt=document.createElement('div');
    const strong=document.createElement('strong'); strong.textContent=c.title || c.question || c.title || c.name; txt.appendChild(strong);
    const preview=document.createElement('div'); preview.className='text';
    if(currentTab==='private' || currentTab==='groups' || currentTab==='forum'){
      const last=c.messages&&c.messages.length?c.messages[c.messages.length-1]:null;
      if(last){ preview.innerHTML=last.text?safeText(last.text).slice(0,120):last.fileName||'Fichier'; }
      else preview.innerHTML="<span class='small-muted'>Aucun message</span>";
    } else if(currentTab==='docs'){
      preview.innerHTML = c.url ? (safeText(c.url).slice(0,80)) : (c.desc? safeText(c.desc).slice(0,80) : 'Document');
    } else if(currentTab==='events'){
      preview.innerHTML = (new Date(c.when)).toLocaleString() + ' ‚Äî ' + (c.location||'');
    } else if(currentTab==='board'){
      preview.innerHTML = (c.content||'').slice(0,120);
    } else if(currentTab==='polls'){
      preview.innerHTML = `${c.options.length} options ¬∑ ${c.totalVotes||0} votes`;
    }
    txt.appendChild(preview);
    const right=document.createElement('div'); right.className='right';
    if(c.lastTs){const time=document.createElement('div');time.className='small-muted';time.textContent=formatRelative(c.lastTs);right.appendChild(time);} else if(c.ts){const time=document.createElement('div');time.className='small-muted';time.textContent=formatRelative(c.ts);right.appendChild(time);} 
    div.appendChild(av); div.appendChild(txt); div.appendChild(right);
    div.onclick=()=>openConversation(c.id);
    sidebar.appendChild(div);
  });
}

// ---------- RENDER MESSAGES ----------
function renderMessages(){
  messagesList.innerHTML='';
  if(!currentId){messagesList.innerHTML='<div class="empty">S√©lectionner une conversation</div>'; return;}
  let list=[];
  if(currentTab==='private') list=state.private;
  if(currentTab==='groups') list=state.groups;
  if(currentTab==='forum') list=state.forum;
  const conv=list.find(c=>c.id===currentId);
  if(!conv||!conv.messages||!conv.messages.length){messagesList.innerHTML='<div class="empty">Aucun message</div>'; return;}
  let lastAuthor='';
  conv.messages.forEach(m=>{
    const d=document.createElement('div'); d.className='msg '+(m.authorId===state.me.id?'me':'other');
    const meta=document.createElement('div'); meta.className='meta';
    if(m.author!==lastAuthor){const s=document.createElement('strong'); s.textContent=m.author; meta.appendChild(s);} 
    const when=document.createElement('span'); when.textContent=formatRelative(m.ts); meta.appendChild(when);
    lastAuthor=m.author;
    const body=document.createElement('div');
    if(m.text) body.innerHTML=safeText(m.text).replace(/\n/g,'<br>');
    if(m.dataUrl && m.fileName){
      if(m.dataUrl.startsWith('data:image') || m.dataUrl.startsWith('https://')) {
        const img=document.createElement('img'); img.src=m.dataUrl; img.className='chat-image'; body.appendChild(img);
      } else {
        const a=document.createElement('a'); a.href=m.dataUrl; a.textContent=m.fileName; a.className='chat-file'; a.download=m.fileName; body.appendChild(a);
      }
    }
    d.appendChild(meta); d.appendChild(body); messagesList.appendChild(d);
  });
  messagesList.scrollTop=messagesList.scrollHeight;
}

// ---------- OPEN CONVERSATION ----------
function openConversation(id){
  currentId=id;
  let list=[];
  if(currentTab==='private') list=state.private;
  if(currentTab==='groups') list=state.groups;
  if(currentTab==='forum') list=state.forum;
  if(currentTab==='docs') list=state.docs;
  if(currentTab==='events') list=state.events;
  if(currentTab==='board') list=state.announcements;
  if(currentTab==='polls') list=state.polls;
  const conv=list.find(c=>c.id==id);
  if(!conv) return;

  // Display header based on type
  if(currentTab==='docs'){
    chatTitle.textContent = 'Documents partag√©s';
    chatAvatar.textContent = 'D';
    chatStatus.textContent = '';
    renderSidebar(); renderDoc(); return;
  }
  if(currentTab==='events'){
    chatTitle.textContent = conv.title || '√âv√©nement';
    chatAvatar.textContent = initials(conv.title||'E');
    chatStatus.textContent = (new Date(conv.when)).toLocaleString();
    renderSidebar(); renderEvent(conv); return;
  }
  if(currentTab==='board'){
    chatTitle.textContent = conv.title || 'Annonce';
    chatAvatar.textContent = initials(conv.title||'A');
    chatStatus.textContent = conv.author || '';
    renderSidebar(); renderAnnouncement(conv); return;
  }
  if(currentTab==='polls'){
    chatTitle.textContent = conv.question || 'Sondage';
    chatAvatar.textContent = initials(conv.question||'S');
    chatStatus.textContent = '';
    renderSidebar(); renderPoll(conv); return;
  }

  // Default: chat-like
  if(conv){
    chatTitle.textContent=conv.title;
    chatAvatar.textContent=initials(conv.title);
    chatStatus.textContent=currentTab==='private'?Math.random()>0.5?'En ligne':'Hors ligne':'';
    if(conv.messages) conv.messages.forEach(m=>{if(m.authorId!==state.me.id)m.read=true;});
    renderSidebar(); renderMessages(); save();
  }
}

// Update UI to show current logged-in user name
function refreshCurrentUserDisplay(){
  const el = document.getElementById('currentUserDisplay');
  if(!el) return;
  el.textContent = `Connect√© : ${state.me.name}`;
}

// Ensure state.me is kept in sync with localStorage.user
function syncCurrentUserFromStorage(){
  const s = (()=>{ try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){ return null } })();
  if(s){
    state.me.id = s.id || state.me.id;
    state.me.name = computeDisplayName(s) || state.me.name;
    save();
  }
  refreshCurrentUserDisplay();
}

// Render helpers for non-chat items
function renderDoc(doc){
  // Always show all documents in a grid/list
  messagesList.innerHTML = '';
  if(!state.docs || state.docs.length === 0) {
    messagesList.innerHTML = '<div class="empty" style="padding:40px">Aucun document partag√©. Cliquez sur "Ajouter doc" pour commencer!</div>';
    return;
  }
  state.docs.forEach(d => {
    const el = document.createElement('div');
    el.className = 'doc-item';
    el.innerHTML = `
      <div class="doc-item-title">${safeText(d.title)}</div>
      <div class="doc-item-meta">Par ${safeText(d.uploader || 'Anonyme')} ¬∑ ${new Date(d.ts || Date.now()).toLocaleString()}</div>
      ${d.desc ? `<div class="doc-item-desc">${safeText(d.desc)}</div>` : ''}
      <div class="doc-item-actions">
        ${d.url ? `<a href="${safeText(d.url)}" target="_blank">üìÑ Ouvrir</a>` : ''}
        <a style="background:#666; cursor:pointer;" onclick="deleteDoc('${d.id}')">üóë Supprimer</a>
      </div>
    `;
    messagesList.appendChild(el);
  });
}

function deleteDoc(docId){
  if(confirm('Supprimer ce document?')) {
    state.docs = state.docs.filter(d => d.id !== docId);
    save();
    renderSidebar();
    renderMessages();
  }
}

function renderEvent(ev){
  messagesList.innerHTML = `<div style="padding:12px"><h3>${safeText(ev.title)}</h3><p>${safeText(ev.desc||'')}</p><p><strong>Quand:</strong> ${new Date(ev.when).toLocaleString()}</p><p><strong>O√π:</strong> ${safeText(ev.location||'En ligne')}</p></div>`;
}

function renderAnnouncement(a){
  messagesList.innerHTML = `<div style="padding:12px"><h3>${safeText(a.title)}</h3><p>${safeText(a.content||'')}</p><p class='small-muted'>Publi√© par ${safeText(a.author||'Anonyme')} ¬∑ ${new Date(a.ts||Date.now()).toLocaleString()}</p></div>`;
}

function renderPoll(p){
  // build poll UI with buttons to vote
  const container = document.createElement('div'); container.style.padding='12px';
  const h = document.createElement('h3'); h.textContent = p.question; container.appendChild(h);
  const info = document.createElement('div'); info.className='small-muted'; info.textContent = `${p.options.length} options ¬∑ ${p.totalVotes||0} votes`; container.appendChild(info);
  const list = document.createElement('div'); list.style.marginTop='12px';
  p.options.forEach((opt, idx)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.marginBottom='8px';
    const label = document.createElement('div'); label.textContent = opt.opt; row.appendChild(label);
    const right = document.createElement('div');
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent = `Voter (${opt.votes||0})`;
    btn.onclick = ()=>{ votePoll(p.id, idx); };
    right.appendChild(btn);
    row.appendChild(right);
    list.appendChild(row);
  });
  container.appendChild(list);
  messagesList.innerHTML=''; messagesList.appendChild(container);
}

function votePoll(pollId, optionIdx){
  const p = state.polls.find(x=>x.id===pollId); if(!p) return; p.options[optionIdx].votes = (p.options[optionIdx].votes||0)+1; p.totalVotes = (p.totalVotes||0)+1; save(); renderPoll(p);
}

// ---------- DOCUMENT MODAL FUNCTIONS ----------
function openDocModal(){
  const modal = document.getElementById('docModal');
  if(modal) {
    modal.classList.add('active');
    document.getElementById('docTitle').focus();
  }
}

function closeDocModal(){
  const modal = document.getElementById('docModal');
  if(modal) modal.classList.remove('active');
  document.getElementById('docTitle').value = '';
  document.getElementById('docUrl').value = '';
  document.getElementById('docDesc').value = '';
  document.getElementById('docModalMessage').textContent = '';
}

async function submitDoc(){
  const title = document.getElementById('docTitle').value.trim();
  const url = document.getElementById('docUrl').value.trim();
  const desc = document.getElementById('docDesc').value.trim();
  const msgEl = document.getElementById('docModalMessage');
  
  // Validation
  if(!title) { msgEl.textContent = '‚ùå Titre requis'; msgEl.style.color = '#ff6b6b'; return; }
  if(!url) { msgEl.textContent = '‚ùå URL requise'; msgEl.style.color = '#ff6b6b'; return; }
  
  try {
    // Try to POST to backend API
    const token = localStorage.getItem('token');
    if(token) {
      const response = await fetch('/api/content/docs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ title, url, description: desc })
      });
      if(response.ok) {
        const data = await response.json();
        msgEl.textContent = '‚úì Document partag√© avec succ√®s!';
        msgEl.style.color = '#51cf66';
        setTimeout(() => { closeDocModal(); switchTab('docs'); renderSidebar(); }, 1500);
        return;
      }
    }
    
    // Fallback to localStorage
    const doc = { id: 'doc-'+uid(), title, url, desc, uploader: state.me.name, ts: Date.now() };
    state.docs.unshift(doc);
    save();
    msgEl.textContent = '‚úì Document partag√© (local)!';
    msgEl.style.color = '#51cf66';
    setTimeout(() => { closeDocModal(); switchTab('docs'); renderSidebar(); openConversation(doc.id); }, 1500);
  } catch(e) {
    msgEl.textContent = '‚ùå Erreur: ' + e.message;
    msgEl.style.color = '#ff6b6b';
  }
}

function createDocPrompt(){
  openDocModal();
}

// ========================================
// NEW CONVERSATION MODAL
// ========================================
function openNewConversationModal(){
  const friendsList = friends.length > 0 ? friends : state.private.map(c => ({ username: c.title }));
  const names = friendsList.map(f => f.username || f.name).join('\n');
  
  if(friendsList.length === 0){
    alert('‚ùå Aucun ami disponible. Visitez la page Amis pour en ajouter.');
    return;
  }
  
  const name = prompt(`S√©lectionner un ami:\n\n${names}\n\nEntrez le nom:`);
  if(!name) return;
  
  const friend = friendsList.find(f => (f.username || f.name).toLowerCase() === name.toLowerCase());
  if(!friend){
    alert('‚ùå Ami non trouv√©');
    return;
  }
  
  // Cr√©er ou ouvrir la conversation
  const friendId = friend.id || ('friend-' + friend.username);
  const convId = 'private-' + friendId;
  let conv = state.private.find(c => c.id === convId);
  
  if(!conv){
    conv = {
      id: convId,
      title: friend.username || name,
      friendId: friendId,
      friendData: friend,
      participants: [friend.username || name, state.me.name],
      messages: [],
      lastTs: Date.now()
    };
    state.private.push(conv);
    save();
  }
  
  renderSidebar();
  openConversation(convId);
}

// ---------- CREATE / POST HELPERS (prompts simple pour prototype) ----------

function createEventPrompt(){
  const title = prompt('Titre de l\'√©v√©nement'); if(!title) return;
  const when = prompt('Date/heure (ISO ou texte) ‚Äî ex: 2025-12-10 18:00');
  const location = prompt('Lieu (ou lien)');
  const desc = prompt('Description / programme');
  const ev = { id: 'ev-'+uid(), title, when: when ? new Date(when).toString() : new Date().toString(), location, desc, organizer: state.me.name, ts: Date.now() };
  state.events.unshift(ev); save(); switchTab('events'); openConversation(ev.id);
}

function createAnnouncementPrompt(){
  const title = prompt('Titre de l\'annonce'); if(!title) return;
  const content = prompt('Contenu de l\'annonce');
  const a = { id: 'ann-'+uid(), title, content, author: state.me.name, ts: Date.now() };
  state.announcements.unshift(a); save(); switchTab('board'); openConversation(a.id);
}

function createPollPrompt(){
  const q = prompt('Question du sondage'); if(!q) return;
  const opts = prompt('Options s√©par√©es par | (ex: Oui|Non|Peut-√™tre)'); if(!opts) return;
  const arr = opts.split('|').map(s=>({ opt: s.trim(), votes: 0 }));
  const p = { id: 'poll-'+uid(), question: q, options: arr, totalVotes: 0, ts: Date.now() };
  state.polls.unshift(p); save(); switchTab('polls'); openConversation(p.id);
}

// ---------- SEND MESSAGE ----------
function sendMessage(){
  if(!currentId) return;
  const text=messageInput.value.trim();
  const file=fileInput.files[0];
  if(!text && !file) return;
  messageInput.value=''; fileInput.value='';
  const msg={id:uid(),author:state.me.name,authorId:state.me.id,ts:Date.now(),read:true};
  if(text) msg.text=text;
  if(file){
    const reader=new FileReader();
    reader.onload=e=>{
      msg.dataUrl=e.target.result; 
      msg.fileName=file.name;
      appendMessage(msg);
      sendMessageToAPI(msg);
    }
    reader.readAsDataURL(file);
  } else {
    appendMessage(msg);
    sendMessageToAPI(msg);
  }
}

async function sendMessageToAPI(msg){
  try{
    const token = localStorage.getItem('token');
    const conv = state.private.find(c => c.id === currentId);
    
    if(!token || !conv || !conv.friendId) return; // Fallback to local only
    
    const payload = {
      recipient_id: conv.friendId,
      content: msg.text || '',
      attachment_url: msg.dataUrl || null,
      attachment_name: msg.fileName || null
    };
    
    const response = await fetch(`${API_URL}/message/send`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(payload)
    });
    
    if(!response.ok) {
      console.warn('Failed to send message to API, stored locally');
    }
  } catch(e){
    console.error('API send error:', e);
  }
}

function appendMessage(msg){
  let list=[];
  if(currentTab==='private') list=state.private;
  if(currentTab==='groups') list=state.groups;
  if(currentTab==='forum') list=state.forum;
  const conv=list.find(c=>c.id===currentId);
  if(!conv.messages) conv.messages=[];
  conv.messages.push(msg);
  renderSidebar(); renderMessages(); save();
}

// ---------- SWITCH TAB ----------
function switchTab(tab){
  currentTab=tab; currentId=null;
  tabPrivate.classList.toggle('active',tab==='private');
  tabGroup.classList.toggle('active',tab==='groups');
  tabForum.classList.toggle('active',tab==='forum');
  // New tabs
  const tabDocs = document.getElementById('tabDocs'); if(tabDocs) tabDocs.classList.toggle('active', tab==='docs');
  const tabEvents = document.getElementById('tabEvents'); if(tabEvents) tabEvents.classList.toggle('active', tab==='events');
  const tabBoard = document.getElementById('tabBoard'); if(tabBoard) tabBoard.classList.toggle('active', tab==='board');
  const tabPolls = document.getElementById('tabPolls'); if(tabPolls) tabPolls.classList.toggle('active', tab==='polls');
  renderSidebar(); renderMessages();
}

// ---------- EVENTS ----------
tabPrivate.onclick=()=>switchTab('private');
tabGroup.onclick=()=>switchTab('groups');
tabForum.onclick=()=>switchTab('forum');
const tabDocsBtn = document.getElementById('tabDocs'); if(tabDocsBtn) tabDocsBtn.onclick=()=>switchTab('docs');
const tabEventsBtn = document.getElementById('tabEvents'); if(tabEventsBtn) tabEventsBtn.onclick=()=>switchTab('events');
const tabBoardBtn = document.getElementById('tabBoard'); if(tabBoardBtn) tabBoardBtn.onclick=()=>switchTab('board');
const tabPollsBtn = document.getElementById('tabPolls'); if(tabPollsBtn) tabPollsBtn.onclick=()=>switchTab('polls');
document.getElementById('sendBtn').onclick=sendMessage;
messageInput.addEventListener('keydown',e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}});

// ---------- INIT ----------
seedExample();
loadFriendsFromAPI(); // Load friends from API
renderSidebar();
// Si on vient d'une page (ami.html) et on a demand√© d'ouvrir une conv
const requested = localStorage.getItem('openConversationId');
if(requested){
  const id = requested; localStorage.removeItem('openConversationId');
  // Rechercher dans toutes les collections
  const collections = ['private','groups','forum','docs','events','announcements','polls'];
  for(const col of collections){
    const list = state[col] || [];
    if(list.find(x=>x.id===id)){
      // map col to tab name
      const map = { private:'private', groups:'groups', forum:'forum', docs:'docs', events:'events', announcements:'board', polls:'polls' };
      const tab = map[col]||'private';
      switchTab(tab);
      openConversation(id);
      break;
    }
  }
}
// synchroniser le nom utilisateur (si connect√© via index.html)
syncCurrentUserFromStorage();
</script>
</body>
</html>

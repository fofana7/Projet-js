
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Param√®tres - Unity</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #accfdb;
      display: flex;
      color: #111827;
    }

    /* SIDEBAR */
    .sidebar {
      width: 90px;
      background: #fff;
      height: 100vh;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      position: fixed;
    }

    .sidebar-icon {
      font-size: 28px;
      margin: 25px 0;
      cursor: pointer;
    }

    /* MAIN WRAPPER */
    .main {
      margin-left: 90px;
      width: 100%;
      display: flex;
      padding: 30px;
      gap: 40px;
    }

    /* LEFT MENU */
    .menu {
      width: 320px;
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      height: fit-content;
    }

    .menu h2 {
      margin: 0 0 20px;
    }

    .menu-section {
      margin-bottom: 25px;
    }

    .menu-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .menu-item {
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
    }
    .menu-item:hover {
      background: #f0f0f0;
    }

    /* RIGHT CONTENT */
    .content {
      flex: 1;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .content h1 {
      margin-top: 0;
      font-size: 28px;
    }

    .profile-box {
      background: #f2f2f2;
      padding: 20px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .profile-pic-small {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
    }

    .btn-edit-photo {
      background: #4a55ff;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
    }

    /* FORM */
    .field {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
    }

    .field label {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .field input, .field textarea, .field select {
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fafafa;
      color: inherit;
    }

    .save-btn {
      padding: 14px 25px;
      background: #4a55ff;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 17px;
      cursor: pointer;
      margin-top: 20px;
    }

    /* LISTE BLOQU√âS */
    .blocked-list {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .blocked-user {
      background: #f7f7f7;
      padding: 15px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .blocked-pic {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    .blocked-name {
      flex: 1;
      margin-left: 18px;
      font-size: 17px;
      font-weight: 600;
    }

    .unblock-btn {
      background: #ff4d4d;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      transition: 0.2s;
    }

    .unblock-btn:hover {
      background: #e03b3b;
    }

    /* Informations personnelles lecture seule */
    #personal-section ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
    }

    #personal-section ul li {
      background: #f7f7f7;
      margin-bottom: 12px;
      padding: 12px 15px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      font-size: 16px;
    }

      /* MOT DE PASSE & S√âCURIT√â */
.security-box {
  background: #f7f7f7;
  padding: 20px;
  border-radius: 15px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.security-box label {
  font-weight: bold;
  margin-bottom: 8px;
  display: block;
  font-size: 16px;
}

.security-box input {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 16px;
  background: #fff;
  transition: border 0.2s;
}

.security-box input:focus {
  border-color: #4a55ff;
  outline: none;
}

#password-strength {
  font-size: 14px;
  margin-top: 5px;
}

#confirm-message {
  font-size: 14px;
  margin-top: 5px;
}

#update-password-btn {
  background: #4a55ff;
  color: white;
  border: none;
  padding: 14px 25px;
  border-radius: 12px;
  font-size: 16px;
  cursor: pointer;
  transition: 0.2s;
}

#update-password-btn:hover {
  background: #3b44d1;
}


 /* CONFIDENTIALIT√â */
.privacy-box {
  background: #f7f7f7;
  padding: 25px 30px;
  border-radius: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.privacy-box h2 {
  margin-top: 20px;
  font-size: 18px;
  color: #4a55ff;
}

.privacy-box p {
  font-size: 16px;
  line-height: 1.6;
  margin-top: 10px;
}


/* D√âCONNEXION */
.logout-box {
  background: #f7f7f7;
  padding: 25px 30px;
  border-radius: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.logout-box p {
  font-size: 16px;
  margin-bottom: 20px;
}

.logout-btn {
  background: #ff4d4d;
  color: white;
  border: none;
  padding: 14px 25px;
  border-radius: 12px;
  font-size: 16px;
  cursor: pointer;
  transition: 0.2s;
}

.logout-btn:hover {
  background: #e03b3b;
}

/* SECTION T√©l√©charger vos donn√©es */
#data-section {
  background: #fff;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

#data-section h1 {
  font-size: 28px;
  margin-bottom: 20px;
}

#data-section p {
  font-size: 16px;
  line-height: 1.6;
  margin-bottom: 25px;
}

#download-data-btn {
  background: #4a55ff;
  color: white;
  border: none;
  padding: 14px 25px;
  border-radius: 12px;
  font-size: 16px;
  cursor: pointer;
  transition: 0.2s;
}

#download-data-btn:hover {
  background: #3b44d1;
}

    /* === TH√àME SOMBRE GLOBAL (appliqu√© via body.theme-dark) === */
    body.theme-dark {
      background: #020617;
      color: #e5e7eb;
    }

    body.theme-dark .sidebar {
      background: #020617;
      border-right-color: #1f2937;
    }

    body.theme-dark .sidebar-icon {
      color: #e5e7eb;
    }

    body.theme-dark .main {
      background: transparent;
    }

    body.theme-dark .menu,
    body.theme-dark .content,
    body.theme-dark #data-section {
      background: #020617;
      color: #e5e7eb;
      box-shadow: 0 2px 18px rgba(15,23,42,0.8);
      border: 1px solid #1f2937;
    }

    body.theme-dark .profile-box {
      background: #0f172a;
    }

    body.theme-dark .field input,
    body.theme-dark .field textarea,
    body.theme-dark .field select {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }

    body.theme-dark .blocked-user,
    body.theme-dark #personal-section ul li,
    body.theme-dark .security-box,
    body.theme-dark .privacy-box,
    body.theme-dark .logout-box {
      background: #020617;
      border: 1px solid #1f2937;
      box-shadow: 0 2px 14px rgba(15,23,42,0.7);
    }

    body.theme-dark .unblock-btn,
    body.theme-dark .logout-btn,
    body.theme-dark .save-btn {
      box-shadow: 0 10px 25px rgba(15,23,42,0.8);
    }


  </style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-icon">üè†</div>
  <div class="sidebar-icon">üîç</div>
  <div class="sidebar-icon">‚ù§Ô∏è</div>
  <div class="sidebar-icon">‚ûï</div>
  <div class="sidebar-icon">üì∏</div>
  <div class="sidebar-icon">üë§</div>
</div>

<div class="main">

  <!-- LEFT MENU -->
  <div class="menu">
    <h2>Param√®tres</h2>

    <div class="menu-section">
      <div class="menu-title">Espace Comptes</div>
      <div class="menu-item" id="menu-personal">Informations personnelles</div>
      <div class="menu-item" id="menu-security">Mot de passe et s√©curit√©</div>
      <div class="menu-item" id="menu-logout">Supprimer le compte</div>

    </div>

    <div class="menu-section">
      <div class="menu-title">Comment vous utilisez Unity</div>
      <div class="menu-item" id="menu-profile">Modifier le profil</div>
      <div class="menu-item" id="menu-data">T√©l√©charger vos donn√©es</div>
    </div>

    <div class="menu-section">
      <div class="menu-title">Confidentialit√©</div>
      <div class="menu-item" id="menu-blocked">Comptes bloqu√©s</div>
      <div class="menu-item" id="menu-confidentialite">Politique de confidentialit√©</div>
    </div>
  </div>

  <!-- RIGHT SECTION -->
  <div class="content">
    <!-- SECTION Modifier le profil -->
    <div class="section" id="profile-section">
      <h1>Modifier le profil</h1>

      <div class="profile-box">
        <div style="display:flex; align-items:center; gap:20px;">
          <img id="settingsProfileAvatar" class="profile-pic-small" src="avatar-placeholder.png" />
          <strong id="settingsProfileName">Nom utilisateur</strong>
        </div>
        <button class="btn-edit-photo">Modifier la photo</button>
      </div>

      <div class="field">
        <label>Site Web</label>
        <input type="text" placeholder="Votre site..." />
      </div>

      <div class="field">
        <label>Bio</label>
        <textarea rows="3" placeholder="Votre bio..."></textarea>
      </div>

      <div class="field">
        <label>Genre</label>
        <select>
          <option>Homme</option>
          <option>Femme</option>
          <option>Autre</option>
        </select>
      </div>

      <div class="field">
        <label>Date de naissance</label>
        <input type="date" />
      </div>

      <div class="field">
        <label>Classe</label>
        <select id="settingsClasseSelect">
          <option value="">Chargement des classes‚Ä¶</option>
        </select>
      </div>

      <div class="field">
        <label>Localisation</label>
        <input type="text" placeholder="Ville, pays" />
      </div>

      <div class="field">
        <label>Th√®me</label>
        <select id="themeSelect">
          <option value="light">Mode clair</option>
          <option value="dark">Mode sombre</option>
          <option value="auto">Automatique</option>
        </select>
      </div>

      <div class="field">
        <label>Langue</label>
        <select>
          <option>Fran√ßais</option>
          <option>Anglais</option>
          <option>Espagnol</option>
        </select>
      </div>

      <div class="field">
        <label>Notifications par email</label>
        <select>
          <option>Important uniquement</option>
          <option>Toutes</option>
          <option>Aucune</option>
        </select>
      </div>

      <div class="field">
        <label>Notifications push</label>
        <select>
          <option>Toutes</option>
          <option>Seulement les messages</option>
          <option>D√©sactiv√©es</option>
        </select>
      </div>

      <div class="field">
        <label>Compte v√©rifi√©</label>
        <select>
          <option>Non v√©rifi√©</option>
          <option>Demander la v√©rification</option>
        </select>
      </div>

      <button class="save-btn" id="save-profile-btn">Enregistrer</button>
    </div>

<!-- Le reste du code reste inchang√© (sections s√©curit√©, bloqu√©s, confidentialit√©, notifications, supprimer compte, t√©l√©charger donn√©es, infos personnelles) -->

<!-- SECTION Mot de passe et s√©curit√© -->
<div class="section" id="security-section" style="display:none;">
  <h1>Mot de passe et s√©curit√©</h1>

  <div class="security-box">
    <label>Mot de passe actuel :</label>
    <input type="password" id="current-password" placeholder="Entrez votre mot de passe actuel">
  </div>

  <div class="security-box">
    <label>Nouveau mot de passe :</label>
    <input type="password" id="new-password" placeholder="Entrez votre nouveau mot de passe">
    <small id="password-strength" style="display:block; margin-top:5px;">Force du mot de passe : </small>
  </div>

  <div class="security-box">
    <label>Confirmer le mot de passe :</label>
    <input type="password" id="confirm-password" placeholder="Confirmez votre nouveau mot de passe">
    <small id="confirm-message" style="display:block; margin-top:5px; color:red;"></small>
  </div>

  <button class="save-btn" id="update-password-btn">Mettre √† jour le mot de passe</button>
</div>

<!-- SECTION Comptes bloqu√©s -->
<div class="section" id="blocked-section" style="display:none;">
  <h1>Comptes bloqu√©s</h1>
  <p>Voici les personnes que vous avez bloqu√©es :</p>

  <div class="blocked-list">
    <div class="blocked-user">
      <img src="https://i.pravatar.cc/150?img=11" class="blocked-pic">
      <span class="blocked-name">Utilisateur1</span>
      <button class="unblock-btn">D√©bloquer</button>
    </div>

    <div class="blocked-user">
      <img src="https://i.pravatar.cc/150?img=12" class="blocked-pic">
      <span class="blocked-name">Utilisateur2</span>
      <button class="unblock-btn">D√©bloquer</button>
    </div>

    <div class="blocked-user">
      <img src="https://i.pravatar.cc/150?img=13" class="blocked-pic">
      <span class="blocked-name">Utilisateur3</span>
      <button class="unblock-btn">D√©bloquer</button>
    </div>
  </div>
</div>

<!-- SECTION Confidentialit√© / Politique de confidentialit√© -->
<div class="section" id="privacy-section" style="display:none;">
  <h1>Politique de confidentialit√©</h1>
  <div class="privacy-box">
    <p>
      Votre vie priv√©e est importante pour nous. Cette politique explique comment nous collectons, utilisons et prot√©geons vos informations personnelles sur RevoSocial.
    </p>
    <h2>1. Informations collect√©es</h2>
    <p>
      Nous collectons les informations que vous fournissez lors de l'inscription, telles que votre nom, email, num√©ro de t√©l√©phone, ainsi que les informations que vous publiez sur le r√©seau social.
    </p>
    <h2>2. Utilisation des informations</h2>
    <p>
      Vos donn√©es sont utilis√©es pour am√©liorer votre exp√©rience sur RevoSocial, personnaliser le contenu, vous envoyer des notifications et s√©curiser votre compte.
    </p>
    <h2>3. Partage des informations</h2>
    <p>
      Nous ne partageons vos informations personnelles avec des tiers que dans les cas n√©cessaires √† la fourniture du service ou si la loi l‚Äôexige.
    </p>
    <h2>4. S√©curit√© des donn√©es</h2>
    <p>
      Nous mettons en place des mesures de s√©curit√© pour prot√©ger vos informations contre l'acc√®s non autoris√©, la modification ou la divulgation.
    </p>
    <h2>5. Vos droits</h2>
    <p>
      Vous pouvez acc√©der √† vos informations, les modifier ou demander leur suppression. Vous pouvez √©galement g√©rer vos pr√©f√©rences de confidentialit√© dans les param√®tres.
    </p>
  </div>
</div>

<!-- SECTION Notifications -->
<div class="section" id="notifications-section" style="display:none;">
  <h1>Notifications</h1>
  <div class="notifications-box">
    <div class="field">
      <label>Notifications par email :</label>
      <select>
        <option>Important uniquement</option>
        <option>Toutes</option>
        <option>Aucune</option>
      </select>
    </div>

    <div class="field">
      <label>Notifications push :</label>
      <select>
        <option>Toutes</option>
        <option>Seulement les messages</option>
        <option>D√©sactiv√©es</option>
      </select>
    </div>

    <button class="save-btn" id="save-notifications-btn">Enregistrer les pr√©f√©rences</button>
  </div>
</div>

<!-- SECTION supprimer le compte -->
<div class="section" id="logout-section" style="display:none;">
  <h1>Supprimer le compte</h1>
  <div class="logout-box">
    <p>
      Cliquez sur le bouton ci-dessous pour proc√©der √† la suppression de votre compte.
    </p>
    <button class="logout-btn" id="logout-btn">Supprimer</button>
  </div>
</div>

<!-- SECTION T√©l√©charger vos donn√©es -->
<div class="section" id="data-section" style="display:none;">
  <h1>T√©l√©charger vos donn√©es</h1>
  <p>
    Vous pouvez t√©l√©charger une copie de toutes les informations que nous avons sur votre compte Unity.
  </p>
  <button class="save-btn" id="download-data-btn">T√©l√©charger mes donn√©es</button>
</div>

<!-- SECTION Informations personnelles lecture seule -->
<div class="section" id="personal-section" style="display:none;">
  <h1>Informations personnelles</h1>
  <ul>
    <li><strong>Nom complet :</strong> <span id="personalFullName">John Doe</span></li>
    <li><strong>Email :</strong> <span id="personalEmail">john.doe@example.com</span></li>
    <li><strong>Num√©ro de t√©l√©phone :</strong> +33 6 12 34 56 78</li>
    <li><strong>Adresse :</strong> 123 Rue Exemple, Paris, France</li>
    <li><strong>Date de naissance :</strong> 01/01/1990</li>
    <li><strong>Genre :</strong> Homme</li>
    <li><strong>Classe :</strong> <span id="personalClasse">Ing√©2</span></li>
    <li><strong>Localisation :</strong> Paris, France</li>
  </ul>
</div>

</div>

</div>

<script>
  // ========== SESSION & UTILISATEUR COURANT ==========
  const SETTINGS_API_BASE = window.location.origin;

  async function loadSettingsUser() {
    try {
      const token = localStorage.getItem('token');
      const storedUser = localStorage.getItem('user');

      // Pas de session => retour √† la page de connexion
      if (!token || !storedUser) {
        window.location.href = 'login.html';
        return;
      }

      let user = null;
      try {
        user = JSON.parse(storedUser);
      } catch {
        user = null;
      }

      // Tentative de rafra√Æchir depuis l'API comme dans profil.html
      try {
        const res = await fetch(`${SETTINGS_API_BASE}/api/users/me`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        if (res.ok) {
          const data = await res.json();
          if (data && data.user) {
            user = data.user;
            localStorage.setItem('user', JSON.stringify(user));
          }
        }
      } catch (e) {
        console.log('API /api/users/me non disponible pour les param√®tres, utilisation du localStorage.');
      }

      if (!user) return;

      const name = user.username || 'Utilisateur';
      const email = user.email || '';
      const classe = user.classe || '';
      const avatarLocal = localStorage.getItem('userAvatarLocal');
      const avatarUrl = avatarLocal || user.avatarurl || 'https://i.pravatar.cc/200';

      const nameEl = document.getElementById('settingsProfileName');
      const avatarEl = document.getElementById('settingsProfileAvatar');
      if (nameEl) nameEl.textContent = name;
      if (avatarEl) avatarEl.src = avatarUrl;

      const fullNameEl = document.getElementById('personalFullName');
      const emailEl = document.getElementById('personalEmail');
      const classeEl = document.getElementById('personalClasse');
      if (fullNameEl) fullNameEl.textContent = name;
      if (emailEl) emailEl.textContent = email;
      if (classeEl && classe) classeEl.textContent = classe;
    } catch (err) {
      console.error('Erreur lors du chargement de l\'utilisateur param√®tres :', err);
    }
  }

  // Charger imm√©diatement les infos utilisateur pour les param√®tres
  loadSettingsUser();

  // Charger la liste des classes pour le s√©lecteur de param√®tres
  async function loadSettingsClasses() {
    const select = document.getElementById('settingsClasseSelect');
    if (!select) return;

    try {
      const res = await fetch(window.location.origin + '/api/classes');
      if (!res.ok) throw new Error('Erreur API classes');
      const data = await res.json();
      const classes = data.classes || [];

      // R√©cup√©rer la classe actuelle de l'utilisateur si dispo
      let currentClasse = '';
      try {
        const userStr = localStorage.getItem('user');
        const u = userStr ? JSON.parse(userStr) : null;
        if (u && u.classe) currentClasse = u.classe;
      } catch {}

      select.innerHTML = '<option value="">S√©lectionne ta classe‚Ä¶</option>';
      classes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.code;
        opt.textContent = c.label ? `${c.code} ‚Äì ${c.label}` : c.code;
        if (currentClasse && currentClasse === c.code) {
          opt.selected = true;
        }
        select.appendChild(opt);
      });
    } catch (e) {
      // En cas d'erreur, proposer quelques valeurs par d√©faut
      select.innerHTML = '';
      ['Sup','Sp2','Ing√©1','Ing√©2','Ing√©3'].forEach(code => {
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = code;
        select.appendChild(opt);
      });
    }
  }

  loadSettingsClasses();

  // ========== NAVIGATION SIDEBAR ==========
  document.querySelectorAll('.sidebar-icon').forEach((icon, index) => {
    icon.addEventListener('click', () => {
      if(index === 0) { // üè† Accueil
        window.location.href = 'index.html';
      } else if(index === 5) { // üë§ Param√®tres (refresh)
        location.reload();
      }
    });
  });

  // ========== NAVIGATION MENU ==========
  const menuMap = {
    'menu-profile': 'profile-section',
    'menu-personal': 'personal-section',
    'menu-security': 'security-section',
    'menu-blocked': 'blocked-section',
    'menu-confidentialite': 'privacy-section',
    'menu-logout': 'logout-section',
    'menu-data': 'data-section'
  };

  // Afficher la premi√®re section par d√©faut
  document.getElementById('profile-section').style.display = 'block';

  // Fonction pour cacher toutes les sections
  function hideAllSections() {
    Object.values(menuMap).forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if(section) section.style.display = 'none';
    });
  }

  // Ajouter les event listeners pour le menu
  Object.keys(menuMap).forEach(menuId => {
    const menuItem = document.getElementById(menuId);
    if(menuItem) {
      menuItem.addEventListener('click', () => {
        hideAllSections();
        const sectionId = menuMap[menuId];
        const section = document.getElementById(sectionId);
        if(section) section.style.display = 'block';
      });
    }
  });

  // ========== MOT DE PASSE ==========
  const newPasswordInput = document.getElementById('new-password');
  const confirmPasswordInput = document.getElementById('confirm-password');
  const passwordStrength = document.getElementById('password-strength');
  const confirmMessage = document.getElementById('confirm-message');
  const updateBtn = document.getElementById('update-password-btn');
  const currentPasswordInput = document.getElementById('current-password');

  if(newPasswordInput) {
    newPasswordInput.addEventListener('input', () => {
      const pwd = newPasswordInput.value;
      let strength = 'Faible';
      let color = 'red';

      const lengthScore = pwd.length >= 8 ? 1 : 0;
      const upperScore = /[A-Z]/.test(pwd) ? 1 : 0;
      const numberScore = /[0-9]/.test(pwd) ? 1 : 0;
      const specialScore = /[\W]/.test(pwd) ? 1 : 0;

      const totalScore = lengthScore + upperScore + numberScore + specialScore;

      if(totalScore === 4) {
        strength = 'Tr√®s fort';
        color = 'green';
      } else if(totalScore === 3) {
        strength = 'Fort';
        color = 'blue';
      } else if(totalScore === 2) {
        strength = 'Moyen';
        color = 'orange';
      }

      if(passwordStrength) {
        passwordStrength.textContent = `Force du mot de passe : ${strength}`;
        passwordStrength.style.color = color;
      }
    });
  }

  if(confirmPasswordInput && newPasswordInput) {
    confirmPasswordInput.addEventListener('input', () => {
      if(confirmPasswordInput.value !== newPasswordInput.value && confirmPasswordInput.value.length > 0){
        if(confirmMessage) confirmMessage.textContent = "‚ùå Les mots de passe ne correspondent pas.";
      } else if(confirmPasswordInput.value === newPasswordInput.value && confirmPasswordInput.value.length > 0) {
        if(confirmMessage) confirmMessage.textContent = "‚úì Les mots de passe correspondent.";
      } else {
        if(confirmMessage) confirmMessage.textContent = "";
      }
    });
  }

  if(updateBtn) {
    updateBtn.addEventListener('click', () => {
      const currentPwd = currentPasswordInput ? currentPasswordInput.value : '';
      const newPwd = newPasswordInput ? newPasswordInput.value : '';
      const confirmPwd = confirmPasswordInput ? confirmPasswordInput.value : '';

      if(!currentPwd || !newPwd || !confirmPwd){
        alert("Veuillez remplir tous les champs.");
        return;
      }

      if(newPwd !== confirmPwd){
        alert("Les mots de passe ne correspondent pas.");
        return;
      }

      const token = localStorage.getItem('token');
      if (!token) {
        alert("Session expir√©e. Merci de vous reconnecter.");
        window.location.href = 'login.html';
        return;
      }

      fetch(`${SETTINGS_API_BASE}/api/auth/change-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ currentPassword: currentPwd, newPassword: newPwd })
      })
      .then(res => res.json().then(body => ({ ok: res.ok, body })))
      .then(({ ok, body }) => {
        if (!ok) {
          alert(body.error || 'Erreur lors de la mise √† jour du mot de passe');
          return;
        }

        alert('Mot de passe mis √† jour avec succ√®s. Vous pourrez utiliser le nouveau √† la prochaine connexion.');
        if(currentPasswordInput) currentPasswordInput.value = '';
        if(newPasswordInput) newPasswordInput.value = '';
        if(confirmPasswordInput) confirmPasswordInput.value = '';
        if(confirmMessage) confirmMessage.textContent = '';
        if(passwordStrength) {
          passwordStrength.textContent = 'Force du mot de passe : Faible';
          passwordStrength.style.color = 'red';
        }
      })
      .catch(() => {
        alert('Erreur r√©seau lors de la mise √† jour du mot de passe');
      });
    });
  }

  // ========== SUPPRIMER LE COMPTE ==========
  const logoutBtn = document.getElementById('logout-btn');
  if(logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      if(confirm('√ätes-vous absolument s√ªr ? Cette action est irr√©versible.')) {
        alert("Votre compte a bien √©t√© supprim√©. A bient√¥t !");
        window.location.href = 'login.html';
      }
    });
  }

  // ========== T√âL√âCHARGER LES DONN√âES ==========
  const downloadBtn = document.getElementById('download-data-btn');
  if(downloadBtn) {
    downloadBtn.addEventListener('click', () => {
      const userData = {
        nom: "John Doe",
        email: "john.doe@example.com",
        dateNaissance: "1990-01-01",
        localisation: "Paris, France",
        bio: "Ma bio...",
        dateExport: new Date().toISOString()
      };

      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(userData, null, 2));
      const downloadAnchor = document.createElement('a');
      downloadAnchor.setAttribute("href", dataStr);
      downloadAnchor.setAttribute("download", "mes_donnees_unity.json");
      document.body.appendChild(downloadAnchor);
      downloadAnchor.click();
      downloadAnchor.remove();
    });
  }

  // ========== BOUTONS DE SAUVEGARDE (Enregistrer) ==========
  const saveBtns = document.querySelectorAll('.save-btn');
  saveBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      // V√©rifier que ce n'est pas le bouton de mise √† jour du mot de passe
      if(btn.id !== 'update-password-btn' && btn.id !== 'save-profile-btn') {
        alert("Vos modifications ont √©t√© enregistr√©es avec succ√®s !");
      }
    });
  });

  // ========== BOUTONS D√âBLOQUER ==========
  const unblockBtns = document.querySelectorAll('.unblock-btn');
  unblockBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const userName = btn.parentElement.querySelector('.blocked-name').textContent;
      if(confirm(`√ätes-vous s√ªr de vouloir d√©bloquer ${userName} ?`)) {
        alert(`${userName} a √©t√© d√©bloqu√© avec succ√®s !`);
        btn.parentElement.remove();
      }
    });
  });

  // ========== TH√àME (clair / sombre / auto) ==========
  // Utiliser la m√™me cl√© que le reste de l'appli pour synchroniser le th√®me
  const THEME_STORAGE_KEY = 'selectedTheme';

  function applyTheme(theme) {
    const body = document.body;
    body.classList.remove('theme-dark');

    let effective = theme;
    if (theme === 'auto') {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      effective = prefersDark ? 'dark' : 'light';
    }

    if (effective === 'dark') {
      body.classList.add('theme-dark');
    }
  }

  function initThemeFromStorage() {
    const select = document.getElementById('themeSelect');
    if (!select) return;

    const saved = localStorage.getItem(THEME_STORAGE_KEY) || 'dark';
    if ([ 'light', 'dark', 'auto' ].includes(saved)) {
      select.value = saved;
    }
    applyTheme(saved);
  }

  function handleProfileSave() {
    const select = document.getElementById('themeSelect');
    const chosen = select ? select.value : 'light';
    localStorage.setItem(THEME_STORAGE_KEY, chosen);
    applyTheme(chosen);

    alert('Profil mis √† jour et th√®me appliqu√© !');
  }

  // Bouton Enregistrer du bloc "Modifier le profil"
  const profileSaveBtn = document.getElementById('save-profile-btn');
  if (profileSaveBtn) {
    profileSaveBtn.addEventListener('click', (e) => {
      e.preventDefault();
      handleProfileSave();
    });
  }

  // Initialiser le th√®me d√®s le chargement
  initThemeFromStorage();

</script>

</body>
</html>
